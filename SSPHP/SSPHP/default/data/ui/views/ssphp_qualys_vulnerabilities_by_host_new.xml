<form version="1.1" theme="dark">
    <label>QUALYS : Vulnerabilities by Host</label>
    <description>v1.1</description>
    
    
    <init>
      <eval token="time_window_earliest">strftime(round(relative_time(now(),"-24h@h")),"%m/%d/%Y %H:%M")</eval>
      <eval token="time_window_latest">strftime(now(),"%m/%d/%Y %H:%M")</eval>
      <eval token="time_window_earliest_epoch">round(relative_time(now(),"-24h@h"))</eval>
      <eval token="time_window_latest_epoch">now()</eval>
    </init>
    
    <!-- ****************************************************** Base Searches **************************************************************************** -->
    
    <search id="base_1">
      <query>
    eventtype=qualys_vm_detection_event earliest=$time_window_earliest_epoch$ latest=$time_window_latest_epoch$
    | fillnull value=- PROTOCOL DNS  
    | dedup 1 HOST_ID, QID, PROTOCOL, STATUS keepempty=true sortby -_time 
    | search STATUS != "FIXED" 
    | stats list(QID) as QID by HOST_ID, IP, DNS, OS
    
    | lookup qualys_kb_lookup QID OUTPUT TITLE SEVERITY 
    | fields HOST_ID, IP, DNS, OS, QID, TITLE, SEVERITY
    
    | lookup ssphp_map_ip_to_azure_rg.csv IP
    
    | eval ssphp_resource_group=lower(ssphp_resource_group)
    | lookup ssphp_resource_service_map.csv ssphp_resource_group
    
    ``` `ssphp_service_id_logic` ```
    
    | eval "Combined Severity"=sum(SEVERITY)
    | sort - "Combined Severity"
    | fields HOST_ID, IP, DNS, OS, QID, TITLE, "Combined Severity", ssphp_*
        </query>
    </search>
    
    <search id="base_2">
      <query>
    | inputlookup ssphp_resource_service_map.csv
    | search ssphp_resource_group!="mc*"
    | table ssphp_level_1_display_name, ssphp_level_2_display_name, ssphp_resource_group, ssphp_subscription, ssphp_subscription_display_name, ssphp_service_team
        </query>
    </search>
    
    
    <!-- ****************************************************** Form Filters **************************************************************************** -->
    
    
    <fieldset autoRun="true" submitButton="false">
      <input type="time" token="tkn_time" searchWhenChanged="true">
        <label>Time Window</label>
        <default>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </default>
        <change>
          <eval token="time_window_earliest">if(isnum($tkn_time.earliest$), strftime($tkn_time.earliest$,"%m/%d/%Y %H:%M"), strftime(relative_time(now(), $tkn_time.earliest$),"%m/%d/%Y %H:%M"))</eval>
          <eval token="time_window_latest">if(isnum($tkn_time.latest$), strftime($tkn_time.latest$,"%m/%d/%Y %H:%M"), strftime(relative_time(now(), $tkn_time.latest$), "%m/%d/%Y %H:%M"))</eval>
          <eval token="time_window_earliest_epoch">if(isnum($tkn_time.earliest$), $tkn_time.earliest$, relative_time(now(), $tkn_time.earliest$))</eval>
          <eval token="time_window_latest_epoch">if(isnum($tkn_time.latest$), $tkn_time.latest$, relative_time(now(), $tkn_time.latest$))</eval>
        </change>
      </input>
      
      <input type="dropdown" token="tkn_group" searchWhenChanged="true">
        <label>DfE Group</label>
        <choice value="*">ALL</choice>
        <default>ALL</default>
        <initialValue>ALL</initialValue>
        <fieldForLabel>ssphp_level_1_display_name</fieldForLabel>
        <fieldForValue>ssphp_level_1_display_name</fieldForValue>
        <search base="base_2">
          <query>
    | search ssphp_level_1_display_name!="NO AZURE DATA AVAILABLE"
    | dedup ssphp_level_1_display_name
    | sort 0 ssphp_level_1_display_name
    | table ssphp_level_1_display_name
            </query>
        </search>
        <change>
          <set token="form.tkn_service">*</set>
        </change>
      </input>
      
      <input type="dropdown" token="tkn_service" searchWhenChanged="true">
        <label>DfE Service</label>
        <choice value="*">ALL</choice>
        <default>ALL</default>
        <initialValue>ALL</initialValue>
        <fieldForLabel>ssphp_level_2_display_name</fieldForLabel>
        <fieldForValue>ssphp_level_2_display_name</fieldForValue>
        <search base="base_2">
          <query>
      | search ssphp_level_1_display_name=$tkn_group|s$ AND ssphp_level_2_display_name!="NO AZURE DATA AVAILABLE"
      | dedup ssphp_level_2_display_name
      | sort 0 ssphp_level_2_display_name
      | table ssphp_level_2_display_name
            </query>
        </search>
      </input>
      
      <input type="checkbox" token="tkn_details" searchWhenChanged="true">
        <label>Vunerability Details</label>
        <choice value="Y">View</choice>
        <initialValue></initialValue>
        <change>
          <condition value="Y">
            <set token="tkn_view_details">, QID, TITLE</set>
            <set token="tkn_table_rows">5</set>
          </condition>
          <condition>
            <set token="tkn_view_details"></set>
            <set token="tkn_table_rows">25</set>
          </condition>
        </change>
      </input>
    </fieldset>
    
    
    <!-- ****************************************************** DISPLAY ROWS **************************************************************************** -->
    
    <row>
      <panel>
        <title>Services with Most Vulnerabilities</title>
        <viz type="sunburst_viz.sunburst_viz">
          <search>
            <query>eventtype=qualys_vm_detection_event earliest=1680188400 latest=1680276964
    | fillnull value=- PROTOCOL DNS  
    | dedup 1 HOST_ID, QID, PROTOCOL, STATUS keepempty=true sortby -_time 
    | search STATUS != "FIXED" 
    | stats list(QID) as QID by HOST_ID, IP, DNS, OS
    
    | lookup qualys_kb_lookup QID OUTPUT TITLE SEVERITY 
    | fields HOST_ID, IP, DNS, OS, QID, TITLE, SEVERITY
    
    | lookup ssphp_map_ip_to_azure_rg.csv IP
    
    | eval ssphp_resource_group=lower(ssphp_resource_group)
    | lookup ssphp_resource_service_map.csv ssphp_resource_group
    
    ``` `ssphp_service_id_logic` ```
    
    | eval "Combined Severity"=sum(SEVERITY)
    | sort - "Combined Severity"
    | fields HOST_ID, IP, DNS, OS, QID, TITLE, "Combined Severity", ssphp_* 
    
    | rename ssphp_level_1_display_name as "DfE Group", ssphp_level_2_display_name as "DfE Service"
    | table HOST_ID, IP, DNS, OS  , "Combined Severity", "DfE Group", "DfE Service", ssphp_product, ssphp_tenant_name, ssphp_subscription_display_name, ssphp_resource_group, ssphp_tech_contact_email
    | eval "DfE Service"='DfE Group'." : ".'DfE Service'
    | stats count by "DfE Service"
  | sort 10 - count</query>
            <earliest>0</earliest>
            <sampleRatio>1</sampleRatio>
          </search>
          <option name="drilldown">none</option>
          <option name="trellis.enabled">0</option>
          <option name="trellis.scales.shared">1</option>
          <option name="trellis.size">medium</option>
        </viz>
      </panel>
    </row>
    
    
    <row>
      <panel>
        <html>
                <style>
                    #header_performance .panel-body.html {
                        background-color: #DDFFDF;
                    }
                </style>
                <h1>$tkn_group$ : $tkn_service$</h1>
          <h3>[$event_count_tkn$ vulerabilities]</h3>
            </html>
      </panel>
    </row>
    
    
    <row>
      <panel>
        <table>
          <title></title>
          <search base="base_1">
            <query>
    
    | search ssphp_level_1_display_name=$tkn_group|s$ AND ssphp_level_2_display_name=$tkn_service|s$
    
    | rename ssphp_level_1_display_name as "DfE Group", ssphp_level_2_display_name as "DfE Service"
    | table HOST_ID, IP, DNS, OS $tkn_view_details$ , "Combined Severity", "DfE Group", "DfE Service", ssphp_product, ssphp_tenant_name, ssphp_subscription_display_name, ssphp_resource_group, ssphp_tech_contact_email
    
    | eventstats count
            </query>
            <done>
              <set token="event_count_tkn">$result.count$</set>
            </done>
          </search>
          <option name="count">$tkn_table_rows$</option>
          <option name="dataOverlayMode">none</option>
          <option name="drilldown">none</option>
          <option name="percentagesRow">false</option>
          <option name="refresh.display">progressbar</option>
          <option name="rowNumbers">false</option>
          <option name="totalsRow">false</option>
          <option name="wrap">true</option>
          <fields>HOST_ID, IP, DNS, OS $tkn_view_details$ , "Combined Severity", "DfE Group", "DfE Service", ssphp_product, ssphp_tenant_name, ssphp_subscription_display_name, ssphp_resource_group, ssphp_tech_contact_email</fields>
        </table>
      </panel>
    </row>
  </form>