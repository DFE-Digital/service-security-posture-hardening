#####################################################################################################################################################
####################################################### GLOBAL ######################################################################################
#####################################################################################################################################################

[default]
action.email = 0
action.rss = 0 
action.summary_index = 0
auto_summarize = 0
counttype = always
disabled = 0
dispatchAs = owner
dispatch.max_count = 500000
dispatch.time_format = %FT%T.%Q%:z
enableSched = 0 
is_visible = 1
max_concurrent = 1 
run_on_startup = 0
request.ui_dispatch_app = SSPHP 
request.ui_dispatch_view = search 
schedule_as = auto
schedule_priority = default 
schedule_window = auto 
workload_pool = standard_perf 



#####################################################################################################################################################
####################################################### AZURE #######################################################################################
#####################################################################################################################################################

[ssphp_create_last_ssphp_drop_csv]
cron_schedule = */5 * * * *
dispatch.earliest_time = -30d@d
dispatch.latest_time = now
enableSched = 1
search = index="ssphp_test" sourcetype="azure:security:finding" host="c113p01-splhf04" source="azure_cloud_defender"\
| stats max(SSPHP_RUN) as last_SSPHP_RUN\
| eval ssphp_source="findings"\
\
| append\
    [search index="ssphp_test" sourcetype="azure:security:alert" host="c113p01-splhf04" source="azure_defender_alerts"\
| stats max(SSPHP_RUN) as last_SSPHP_RUN\
| eval ssphp_source="alerts"]\
| outputlookup createinapp=t append=f ssphp_last_ssphp_drop.csv


###############################################################################################################################################################

[ssphp_create_resource_service_map_csv]
cron_schedule = 15 * * * *
dispatch.earliest_time = 0
dispatch.latest_time = now
enableSched = 1
search = index="ssphp_test" sourcetype="azure:resource:group"\
       ```[search index="ssphp_test" sourcetype="azure:resource:group" earliest=-3d@d latest=now | stats max(_time) as _time | return _time]```\
| dedup name\
\
| rename name as ssphp_resource_group, location as ssphp_location, "tags.Parent Business" as ssphp_parent_business, tags.Portfolio as ssphp_portfolio, tags.Product as ssphp_product, tags.Service as ssphp_service, "tags.Service Line" as ssphp_service_line, "tags.Service Offering" as ssphp_service_offering, tags.costcenter as ssphp_cost_centre, tags.environment as ssphp_environment\
| eval id=lower(id), ssphp_resource_group=lower(ssphp_resource_group)\
| rex field=id "^\/subscriptions\/(?<ssphp_subscription>[^\/]+)"\
| rex field=ssphp_resource_group "^(?<ssphp_business_service_index>s\d{3})(?<ssphp_environment>p|d|t)[^-]+-(?<ssphp_service_team>[\s\S]*)$"\
| eval ssphp_environment=case(ssphp_environment="t","Test",ssphp_environment="d","Development",ssphp_environment="p","Production",1==1,"Unknown")\
| fields ssphp_subscription, ssphp_resource_group, ssphp_business_service_index, ssphp_environment, ssphp_service_team, ssphp_location, ssphp_parent_business, ssphp_portfolio, ssphp_product, ssphp_service, ssphp_service_line, ssphp_service_offering\
\
| join type=outer ssphp_subscription\
    [search index="ssphp_test" sourcetype="azure:subscriptions" \
    | dedup subscriptionId\
       ```[search index="ssphp_test" sourcetype="azure:subscriptions" earliest=-3d@d latest=now | stats max(_time) as _time | return _time]```\
\
    | rename tenantId as ssphp_tenant, subscriptionId aS ssphp_subscription, displayName as ssphp_subscription_display_name\
    | fields ssphp_subscription, ssphp_tenant, ssphp_subscription_display_name]\
\
| lookup ssphp_business_service_index.csv "Service ID" as ssphp_business_service_index OUTPUT "Cost Centre" as ssphp_cost_centre, "DevOps Site" as ssphp_devops_site, SRO as ssphp_sro, "Service Name" as ssphp_service_name, "Tech Directorate Architect Partner" as ssphp_tech_dir_arch_partner, "Tech Directorate Service Management Contact" as ssphp_tech_dir_serv_mgmt_contact, "Technical Contact Email" as ssphp_tech_contact_email\
\
`ssphp_service_id_logic`\
\
| eval ssphp_service_shortname=case(ssphp_service_name="Regional Service Delivery","RSD",1==1,"Unknown"),\
       ssphp_tenant_name=case(ssphp_tenant="9c7d9dd3-840c-4b3f-818e-552865082e16","CIP",ssphp_tenant="fad277c9-c60a-4da1-b5f3-b3b8b34a82f9","T1",1==1,"SFA : ".substr(ssphp_tenant,0,8))\
\
| fillnull value="Unknown"\
| table ssphp_tenant, ssphp_tenant_name, ssphp_subscription, ssphp_subscription_display_name, ssphp_resource_group, ssphp_business_service_index, ssphp_service_name, ssphp_service_shortname, ssphp_environment, ssphp_service_team, ssphp_location, ssphp_parent_business, ssphp_portfolio, ssphp_product, ssphp_service, ssphp_service_line, ssphp_service_offering, ssphp_cost_centre, ssphp_devops_site, ssphp_sro, ssphp_tech_dir_arch_partner, ssphp_tech_dir_serv_mgmt_contact, ssphp_tech_contact_email\
\
| outputlookup createinapp=t append=f ssphp_resource_service_map.csv


######################################################################################################################################################

[ssphp_create_base_azure_resource_list_csv]
dispatch.earliest_time = -30d@d 
dispatch.latest_time = now 
search = index="eventhub" sourcetype="mscs:azure:eventhub"\
\
| eval resource_id=mvdedup(coalesce(resourceId,ResourceId,id,Id))\
| search resource_id="*/RESOURCEGROUPS/*"\
| dedup resource_id\
| table resource_id\
| rename resource_id as _raw\
| extract pairdelim="/" kvdelim="/"\
| eval ssphp_resource_group=coalesce(resourceGroups,resourcegroups,RESOURCEGROUPS), \
       VIRTUALMACHINES=coalesce(VIRTUALMACHINES,virtualMachines,virtualmachines),\
       ssphp_subscription=coalesce(subscriptions, SUBSCRIPTIONS)\
\
| fields - _raw, activityLogAlerts, providers, PROVIDERS, resourceGroups, resourcegroups, assessments, subassessments, virtualMachines, virtualmachines, RESOURCEGROUPS, _kv, SUBSCRIPTIONS, subscriptions\
\
| rename * as zzz_*, zzz_ssphp_* as ssphp_*\
| foreach zzz_* [eval ssphp_resource=mvappend(ssphp_resource,if(isnotnull('<<FIELD>>'),"<<FIELD>>"." = ".'<<FIELD>>',null()))]\
| fields ssphp_resource_group, ssphp_subscription, ssphp_resource\
| mvexpand ssphp_resource\
| eval ssphp_resource=substr(ssphp_resource,5)\
\
| dedup ssphp_resource_group, ssphp_subscription, ssphp_resource\
\
| outputlookup createinapp=t append=f ssphp_azure_resource_list.csv


#####################################################################################################################################################

[ssphp_create_incremental_azure_resource_list_csv]
cron_schedule = */30 * * * * 
dispatch.earliest_time = -60m@m 
dispatch.latest_time = now 
enableSched = 1 
search = | inputlookup ssphp_azure_resource_list.csv\
\
| append \
    [search index="eventhub" sourcetype="mscs:azure:eventhub" earliest=-1h@h latest=now\
\
| eval resource_id=mvdedup(coalesce(resourceId,ResourceId,id,Id))\
| search resource_id="*/RESOURCEGROUPS/*"\
| dedup resource_id\
| table resource_id\
| rename resource_id as _raw\
| extract pairdelim="/" kvdelim="/"\
| eval ssphp_resource_group=coalesce(resourceGroups,resourcegroups,RESOURCEGROUPS), \
       VIRTUALMACHINES=coalesce(VIRTUALMACHINES,virtualMachines,virtualmachines),\
       ssphp_subscription=coalesce(subscriptions, SUBSCRIPTIONS)\
\
| fields - _raw, activityLogAlerts, providers, PROVIDERS, resourceGroups, resourcegroups, assessments, subassessments, virtualMachines, virtualmachines, RESOURCEGROUPS, _kv, SUBSCRIPTIONS, subscriptions\
\
| rename * as zzz_*, zzz_ssphp_* as ssphp_*\
| foreach zzz_* [eval ssphp_resource=mvappend(ssphp_resource,if(isnotnull('<<FIELD>>'),"<<FIELD>>"." = ".'<<FIELD>>',null()))]\
| fields ssphp_resource_group, ssphp_subscription, ssphp_resource\
| mvexpand ssphp_resource\
| eval ssphp_resource=substr(ssphp_resource,5)]\
\
| dedup ssphp_resource_group, ssphp_subscription, ssphp_resource\
\
| outputlookup createinapp=t append=f ssphp_azure_resource_list.csv




#####################################################################################################################################################
####################################################### GITHUB ######################################################################################
#####################################################################################################################################################


[ssphp_github_create_summary__change_branch_protection_rules]
cron_schedule = */30 * * * *
dispatch.earliest_time = 0
dispatch.latest_time = now
enableSched = 1
search = `github_data_source` rule.name=*\
```| table _time, action, repository.name, rule.name, changes.name.from, changes.*```\
\
| eval ssphp_tech_source="Github",\
       ssphp_use_case="Change Branch Protection Rules",\
       ssphp_action='action',\
       ssphp_created_at='last_updated',\
       ssphp_details=mvappend("Rule = ".'rule.name', "Name Changed From = ".'changes.name.from', "Merge Queue Enforcement Level From = ".'changes.merge_queue_enforcement_level.from', "Deployment Changes Required Enforcement Level = ".'changes.required_deployments_enforcement_level.from'),\
       ssphp_severity="medium",\
       ssphp_repository='repository.full_name',\
       ssphp_state='alert.state',\
       ssphp_url='alert.security_advisory.references{}.url',\
       ssphp_original_event=md5(_time._raw),\
       SSPHP_RUN=now(),\
       ssphp_event_time=strftime(_time,"%Y-%m-%d %H:%M:%S")\
       \
`ssphp_write_summary_findings_data`


#####################################################################################################################################################

[ssphp_github_create_summary__codeql]
cron_schedule = */30 * * * *
dispatch.earliest_time = 0
dispatch.latest_time = now
enableSched = 1
search = `github_data_source` alert.tool.name="CodeQL"\
| sort 0 - _time\
| eval ssphp_event_time=strftime(_time,"%Y-%m-%d %H:%M:%S"),\
       ssphp_original_event=md5(_time._raw)\
\
| stats list(action) as actions, values(*) as * by alert.html_url\
| fields - action\
| where mvindex(actions,0)!="fixed"\
\
| eval ssphp_tech_source="Github",\
       ssphp_use_case="CodeQL",\
       ssphp_action='actions',\
       ssphp_created_at='alert.created_at',\
       ssphp_details=mvappend("Category = ".'alert.most_recent_instance.category',\
                              "Location Path = ".'alert.most_recent_instance.location.path', \
                              "Message Text = ".'alert.most_recent_instance.message.text', \
                              "Commit Branch = ".'commit_branch', \
                              "Commit SHA = ".'alert.most_recent_instance.commit_sha', \
                              "Push Time = ".'repository.pushed_at'),\
       ssphp_severity='alert.rule.severity',\
       ssphp_repository='repository.full_name',\
       ssphp_state='alert.state',\
       ssphp_url='alert.html_url',\
       SSPHP_RUN=now()\
       ssphp_event_time=strftime(_time,"%Y-%m-%d %H:%M:%S")\
       \
`ssphp_write_summary_findings_data`


#####################################################################################################################################################

[ssphp_github_create_summary__cve]
cron_schedule = */30 * * * *
dispatch.earliest_time = 0
dispatch.latest_time = now
enableSched = 1
search = `github_data_source` alert.security_advisory.cve_id="*"\
\
| eval ssphp_tech_source="Github",\
       ssphp_use_case="CVE",\
       ssphp_action='action',\
       ssphp_created_at='alert.created_at',\
       ssphp_details=mvappend("CVE ID = ".'alert.security_advisory.cve_id	',"Descrption = ".'alert.security_advisory.description',"Ecosystem = ".'alert.security_vulnerability.package.ecosystem',"Package = ".'alert.security_vulnerability.package.name'),\
       ssphp_severity='alert.security_advisory.severity',\
       ssphp_repository='repository.full_name',\
       ssphp_state='alert.state',\
       ssphp_url='alert.security_advisory.references{}.url',\
       ssphp_original_event=md5(_time._raw),\
       SSPHP_RUN=now(),\
       ssphp_event_time=strftime(_time,"%Y-%m-%d %H:%M:%S")\
       \
`ssphp_write_summary_findings_data`


#####################################################################################################################################################

[ssphp_github_create_summary__disable_secret_scanning]
cron_schedule = */30 * * * *
dispatch.earliest_time = 0
dispatch.latest_time = now
enableSched = 1
search = `github_data_source` changes.from.security_and_analysis.secret_scanning.status="enabled"\
\
```| table _time, changes.from.security_and_analysis.secret_scanning.status, changes.from.security_and_analysis.secret_scanning_push_protection.status, repository.name```\
\
| eval ssphp_tech_source="Github",\
       ssphp_use_case="Disable Secret Scanning",\
       ssphp_action="change",\
       ssphp_created_at='last_updated',\
       ssphp_details=mvappend("Secret Scanning Status Before Change = ".'changes.from.security_and_analysis.secret_scanning.status', "Push Protection Status Before Change = ".'changes.from.security_and_analysis.secret_scanning_push_protection.status'),\
       ssphp_severity="high",\
       ssphp_repository='repository.full_name',\
       ssphp_state='alert.state',\
       ssphp_url='alert.security_advisory.references{}.url',\
       ssphp_original_event=md5(_time._raw),\
       SSPHP_RUN=now(),\
       ssphp_event_time=strftime(_time,"%Y-%m-%d %H:%M:%S")\
       \
`ssphp_write_summary_findings_data`


#####################################################################################################################################################

[ssphp_github_create_summary__repo_made_public]
cron_schedule = */30 * * * *
dispatch.earliest_time = 0
dispatch.latest_time = now
enableSched = 1
search = `github_data_source` action="publicized"\
```| table _time, action, repository.name, sender.login, sender.url```\
\
| eval ssphp_tech_source="Github",\
       ssphp_use_case="Repo Made Public",\
       ssphp_action='action',\
       ssphp_created_at='last_updated',\
       ssphp_details=mvappend("User Login = ".'sender.login', "User URL = ".'sender.url'),\
       ssphp_severity="high",\
       ssphp_repository='repository.full_name',\
       ssphp_state="-",\
       ssphp_url='alert.security_advisory.references{}.url',\
       ssphp_original_event=md5(_time._raw),\
       SSPHP_RUN=now(),\
       ssphp_event_time=strftime(_time,"%Y-%m-%d %H:%M:%S")\
       \
`ssphp_write_summary_findings_data`


#####################################################################################################################################################

[ssphp_github_create_summary__secret]
cron_schedule = */30 * * * *
dispatch.earliest_time = 0
dispatch.latest_time = now
enableSched = 1
search = `github_data_source` action=* alert.secret_type=* location.type=*\
\
| eval ssphp_tech_source="Github",\
       ssphp_use_case="Secret",\
       ssphp_action='action',\
       ssphp_created_at='alert.created_at',\
       ssphp_details=mvappend("Secret Type = ".'alert.secret_type', "Location Path = ".'location.details.path', "Push Protection Bypassed? = ".'alert.push_protection_bypassed', "Alert Resolved At = ".'alert.resolved_at', "Alert Resolved By = ".'alert.resolved_by', "Commit URL = ".'location.details.commit_url'),\
       ssphp_severity='severity',\
       ssphp_repository='repository.full_name',\
       ssphp_state='alert.state',\
       ssphp_url='alert.security_advisory.references{}.url',\
       ssphp_original_event=md5(_time._raw),\
       SSPHP_RUN=now(),\
       ssphp_event_time=strftime(_time,"%Y-%m-%d %H:%M:%S")\
       \
`ssphp_write_summary_findings_data`