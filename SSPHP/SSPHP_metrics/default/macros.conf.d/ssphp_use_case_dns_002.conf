[ssphp_use_case_dns_002]
definition = """
`ssphp_metrics_data_index` sourcetype="list_users"
    [| search `ssphp_metrics_data_index` sourcetype="list_users" | stats max(SSPHP_RUN) as SSPHP_RUN | return SSPHP_RUN]
| rename Arn as ssphp_user_arn

| join type=outer ssphp_user_arn 
    [| search `ssphp_metrics_data_index` sourcetype="get_user_policy"
    [| search `ssphp_metrics_data_index` sourcetype="get_user_policy" | stats max(SSPHP_RUN) as SSPHP_RUN | return SSPHP_RUN]
    | rename UserArn as ssphp_user_arn, 
             PolicyDocument.Statement{}.Condition.IpAddress.aws:SourceIp{} as ssphp_policy_condition_ip_address, 
             PolicyDocument.Statement.Condition.NotIpAddress.aws:SourceIp{} as ssphp_policy_condition_not_ip_address
    | stats values(ssphp_policy_condition_ip_address) as ssphp_policy_condition_ip_address, values(ssphp_policy_condition_not_ip_address) as ssphp_policy_condition_not_ip_address by ssphp_user_arn]
    
| join type=outer ssphp_user_arn 
    [| search `ssphp_metrics_data_index` sourcetype="get_attached_user_policy"
    [| search `ssphp_metrics_data_index` sourcetype="get_attached_user_policy" | stats max(SSPHP_RUN) as SSPHP_RUN | return SSPHP_RUN]
    | rename UserArn as ssphp_user_arn, AttachedPolicies{}.PolicyName as ssphp_attached_policies_policy_name
    | stats values(ssphp_attached_policies_policy_name) as ssphp_attached_policies_policy_name by ssphp_user_arn
    | eval ssphp_attached_policies_policy_name=mvjoin(ssphp_attached_policies_policy_name,"~~~")]

| eval ssphp_policy_type_1=if(like('ssphp_policy_condition_ip_address',"%1.1.1.1%"),1,null()),
       ssphp_policy_type_2=if(like('ssphp_policy_condition_not_ip_address',"%95.91.255.183/32%"),2,null()),
       ssphp_policy_type_3=if(like('ssphp_attached_policies_policy_name',"%AWSBillingConductorFullAccess%"),3,null()),
       ssphp_ip_policy_success_types=mvappend(ssphp_policy_type_1,ssphp_policy_type_2,ssphp_policy_type_3)
| fillnull value=0 ssphp_ip_policy_success_types

| eval ssphp_attached_policies_policy_name=split(ssphp_attached_policies_policy_name,"~~~")
| table ssphp_user_arn, UserName, ssphp_policy_condition_ip_address, ssphp_policy_condition_not_ip_address, ssphp_attached_policies_policy_name, ssphp_ip_policy_success_types
| search ssphp_user_arn=*

"""

iseval = 0