[ssphp_use_case_aad_001]
definition = """
index=test sourcetype="users.get"
    [| search index=test sourcetype="users.get"
     | stats max(SSPHP_RUN) as SSPHP_RUN
     | return SSPHP_RUN]
| rename id as user_id, displayName as user_display_name
| eval assignedPlans=mvdedup('assignedPlans{}.service')

| join type=outer user_id 
    [| search index=test sourcetype="role_management_assignments.get"
        [| search index=test sourcetype="role_management_assignments.get" | stats max(SSPHP_RUN) as SSPHP_RUN | return SSPHP_RUN]
     | rename principalId as user_id, roleDefinitionId as role_definition_id

     | join type=outer role_definition_id 
         [| search index=test sourcetype="role_management.definitions.get"
             [| search index=test sourcetype="role_management.definitions.get" | stats max(SSPHP_RUN) as SSPHP_RUN | return SSPHP_RUN]
              | rename id as role_definition_id, displayName as role_display_name
              | table role_definition_id, description, role_display_name, rolePermissions{}.allowedResourceActions{}, inheritsPermissionsFrom{}.id, inheritsPermissionsFrom@odata.context, isBuiltIn, isEnabled, isPrivileged, resourceScopes{}]
    ]

| table user_id, user_display_name, userPrincipalName, givenName, surname, assignedPlans, role_definition_id, role_display_name, description, rolePermissions{}.allowedResourceActions{}, inheritsPermissionsFrom{}.id, isBuiltIn, isEnabled, isPrivileged
| search isPrivileged="true" AND assignedPlans="*MultiFactorService*"

"""

iseval = 0