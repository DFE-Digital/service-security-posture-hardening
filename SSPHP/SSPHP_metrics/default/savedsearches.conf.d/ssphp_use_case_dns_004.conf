[ssphp_use_case_dns_004]
cron_schedule = 60 * * * *
description = Defender detected an Alert in Azure
dispatch.earliest_time = 0
dispatch.latest_time = now
enableSched = 1
search = """
index=test sourcetype="describe_organization"
| rex field=Arn "[^:]*:[^:]*:[^:]*:[^:]*:(?<account_id>[^:]*):"
| eval account_id=coalesce(account_id,AccountId)

| eventstats max(_time) as max_time by account_id
| where _time=max_time

| table _time, account_id, *
| stats dc(account_id) as number_of_accounts, sum(eval(if(InOrganization="false",1,0))) as number_of_accounts_not_in_organization
| eval ssphp.score=number_of_accounts_not_in_organization*100/number_of_accounts
| fields ssphp.score

``` add metadata ```
| eval SSPHP_RUN=round(now()),
       ssphp.use_case.id="dns_004",
       ssphp.use_case.description="This use case tests whether all AWS accounts are part of an 'Organisation'",
       ssphp.use_case.version="1.0.0",
       ssphp.use_case.last_changed.date="2023-07-10",
       ssphp.use_case.last_changed.by="Ian Pearl"
       
| makejson SSPHP_RUN, ssphp* output=_raw
| fields _raw

```| spath input=json```
| collect output_format=hec testmode=f addinfo=f index="ssphp_metrics"

"""
