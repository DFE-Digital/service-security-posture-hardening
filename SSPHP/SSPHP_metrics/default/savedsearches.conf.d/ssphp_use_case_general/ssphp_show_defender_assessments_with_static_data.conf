[ssphp_show_defender_assessments_with_static_data]
cron_schedule = 0 8 * * *
disabled = 0
dispatch.earliest_time = 0
dispatch.latest_time = now

search = """

index="ssphp_metrics_data" sourcetype="azure_resource_graph_TBD" type="microsoft.security/assessments*" earliest=-1d@d latest=now
    NOT (properties.resourceDetails.ResourceType="subscription" OR properties.statusPerInitiative{}.assessmentStatus.code="NotApplicable")
    
    [| search index="ssphp_metrics_data" sourcetype="azure_resource_graph_TBD" type="microsoft.security/assessments*" earliest=-1d@d latest=now
         NOT (properties.resourceDetails.ResourceType="subscription" OR properties.statusPerInitiative{}.assessmentStatus.code="NotApplicable")
      | stats max(SSPHP_RUN) as SSPHP_RUN
      | eval SSPHP_RUN=substr('SSPHP_RUN',0,5)."*"
      | return SSPHP_RUN]

| eval id=lower('properties.resourceDetails.ResourceId')

``` Add our SSPHP service tags from the YAML ```
`ssphp_add_service_metadata`



``` Only show the Assessments for which the ResouceGroups have YAML files```
| search [| search index="ssphp_metrics_data" sourcetype="metadata_azure" type="AzureResourceGroup" 
                [| search index="ssphp_metrics_data" sourcetype="metadata_azure" type="AzureResourceGroup" 
                 | stats max(SSPHP_RUN) as SSPHP_RUN 
                 | return SSPHP_RUN]
          | rename service.name as ssphp_service_name
          | stats values(ssphp_service_name) as ssphp_service_name
          | eval search_text="(ssphp_service_name=\"".mvjoin('ssphp_service_name',"\" OR ssphp_service_name=\"")."\")"
          | return $search_text]



``` Add the Normalised Tags from the Azure Resources themselves ```
| lookup ssphp_azure_resource_tags.csv id
| fillnull value="-" azure_tag_environment, azure_tag_parent_business, azure_tag_portfolio, azure_tag_product, azure_tag_service, azure_tag_service_line, azure_tag_service_offering
| eval azure_service_tags=mvappend("environment=".'azure_tag_environment',
                             "parent_business=".'azure_tag_parent_business',
                             "portfolio=".'azure_tag_portfolio',
                             "product=".'azure_tag_product',
                            
                            
                            
                             "service=".'azure_tag_service',
                             "service_line=".'azure_tag_service_line',
                             "service_offering=".'azure_tag_service_offering')

        
```Get the Policy Related Info - the CIS benchmark stuff```
| where isnotnull('properties.metadata.policyDefinitionId')
| eval properties.metadata.policyDefinitionId=lower('properties.metadata.policyDefinitionId')
| rex field=properties.metadata.policyDefinitionId "^/providers/microsoft.authorization/policydefinitions/(?<policy_guid>.*)$"

 | lookup ssphp_policy_to_cis.csv policy_guid
 | eval lf="
",
       cis_v8_ids=split('cis_v8_ids','lf'),
       cis_safeguard_id=split('cis_safeguard_id','lf'),
       cis_control_name=split('cis_control_name','lf'),
       cis_control=split('cis_control','lf'),
       control_domain=split('control_domain','lf'),
       description=split('description','lf'),
       security_function=split('security_function','lf'),
       security_principal=split('security_principal','lf'),
       title=split('title','lf')


```Output```
| rename id as resourceId
| table ```resourceId, ```tenantId, subscriptionId, resourceGroup, properties.resourceDetails.ResourceName, properties.resourceDetails.ResourceType, 
        properties.metadata.displayName, properties.metadata.description, properties.statusPerInitiative{}.assessmentStatus.code, ```properties.status.description```, properties.metadata.severity, properties.metadata.securityIssue, properties.metadata.remediationDescription, properties.metadata.threats{}, properties.metadata.userImpact, properties.status.firstEvaluationDate, properties.status.statuschangeDate,
        properties.metadata.policyDefinitionId, policy_guid,
        ssphp_service_display_name, ssphp_service_division, ssphp_service_group, ssphp_service_name, ssphp_service_portfolio, ssphp_tags,
        azure_service_tags,
        security_function, security_principal, control_domain, cis_control, cis_control_name, cis_safeguard_id, title, cis_v8_ids, description, ig1, ig2, ig3



``` TO USE THE OUTPUT FROM THIS SAVEDSEARCH
| loadjob savedsearch="nobody:SSPHP_metrics:ssphp_show_defender_assessments_with_static_data"
```

"""