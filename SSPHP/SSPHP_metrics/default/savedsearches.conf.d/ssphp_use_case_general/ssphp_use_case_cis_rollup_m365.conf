[ssphp_use_case_cis_rollup_m365]
cron_schedule = */15 * * * *
dispatch.earliest_time = 0
dispatch.latest_time = now
enableSched = 1
search = """
| search `ssphp_metrics_index` ssphp.use_case.id="m365*" ssphp.cis_navigator.ig="1"
| dedup ssphp.use_case.id

| fields ssphp.*

| eval weighting='ssphp.risk.expectancy'*'ssphp.risk.impact'*100/25,
       weighted_score='ssphp.score.score'*'weighting'/100

``` there is going to need to be some code here to mvexpand the m365 benchmark controls which are mv fields because they roll up into a number of different safeguards ```

| appendpipe 
    [| stats sum(weighted_score) as total_weighted_score,
             sum(weighting) as total_weightings,
             list(ssphp.use_case.id) as ssphp.use_cases.id,
             list(ssphp.score.score) as ssphp.use_cases.score,
             list(ssphp.score.color) as ssphp.use_cases.color,
             list(ssphp.score.title) as ssphp.use_cases.title,
             values(ssphp.cis_navigator.title) as ssphp.cis_navigator.title,
             values(ssphp.cis_navigator.caf) as ssphp.cis_navigator.caf,
             values(ssphp.cis_navigator.control) as ssphp.cis_navigator.control,
             values(ssphp.cis_navigator.control_group) as ssphp.cis_navigator.control_group,
             values(ssphp.cis_navigator.asset_type) as ssphp.cis_navigator.asset_type,
             values(ssphp.cis_navigator.description) as ssphp.cis_navigator.description
       by ssphp.cis_navigator.safeguard
     | eval ssphp.score.score='total_weighted_score'*100/'total_weightings',
            ssphp.use_case.id="m365_".'ssphp.cis_navigator.safeguard'."_000"
     | fields ssphp.use_case.id, ssphp.score.score, ssphp.use_cases.id, ssphp.use_cases.score, ssphp.use_cases.color, ssphp.use_cases.color, ssphp.cis_navigator.title, ssphp.cis_navigator.caf, ssphp.cis_navigator.control, ssphp.cis_navigator.control_group, ssphp.cis_navigator.safeguard, ssphp.cis_navigator.asset_type, ssphp.cis_navigator.description]

| appendpipe 
    [| search ssphp.use_case.id!="*_000"
     | stats sum(weighted_score) as total_weighted_score,
             sum(weighting) as total_weightings,
             list(ssphp.use_case.id) as ssphp.use_cases.id,
             list(ssphp.score.score) as ssphp.use_cases.score,
             list(ssphp.score.color) as ssphp.use_cases.color,
             list(ssphp.score.title) as ssphp.use_cases.title,
             values(ssphp.cis_navigator.title) as ssphp.cis_navigator.title,
             values(ssphp.cis_navigator.caf) as ssphp.cis_navigator.caf,
             values(ssphp.cis_navigator.safeguard) as ssphp.cis_navigator.safeguard,
             values(ssphp.cis_navigator.control_group) as ssphp.cis_navigator.control_group,
             values(ssphp.cis_navigator.asset_type) as ssphp.cis_navigator.asset_type,
             values(ssphp.cis_navigator.description) as ssphp.cis_navigator.description
       by ssphp.cis_navigator.control
     | eval ssphp.score.score='total_weighted_score'*100/'total_weightings',
            ssphp.use_case.id="m365_".'ssphp.cis_navigator.control'."_000"
     | fields ssphp.use_case.id, ssphp.score.score, ssphp.use_cases.id, ssphp.use_cases.score, ssphp.use_cases.color, ssphp.use_cases.title, ssphp.cis_navigator.title, ssphp.cis_navigator.caf, ssphp.cis_navigator.control, ssphp.cis_navigator.control_group, ssphp.cis_navigator.safeguard, ssphp.cis_navigator.asset_type, ssphp.cis_navigator.description]

| fields ssphp.use_case.id, ssphp.score.score, ssphp.use_cases.score, ssphp.use_cases.id, ssphp.use_cases.color, ssphp.use_cases.color, ssphp.cis_navigator.title, ssphp.cis_navigator.caf, ssphp.cis_navigator.control, ssphp.cis_navigator.control_group, ssphp.cis_navigator.safeguard, ssphp.cis_navigator.asset_type, ssphp.cis_navigator.description

| search ssphp.use_case.id="*_000"


``` add metadata ```
| eval SSPHP_RUN=round(now()),
       ssphp.use_case.title=case(match('ssphp.use_case.id',"m365_[^\.]*_000"),'ssphp.cis_navigator.control_group',
                                 match('ssphp.use_case.id',"m365_\d*\.\d*_000"),'ssphp.cis_navigator.title',
                                 1==1,"Whoops"),
       ssphp.use_case.description=case(match('ssphp.use_case.id',"m365_[^\.]*_000"),"Rollup Metrics for ".'ssphp.cis_navigator.control_group',
                                 match('ssphp.use_case.id',"m365_\d*\.\d*_000"),'ssphp.cis_navigator.description',
                                 1==1,"Whoops"),
       ssphp.use_case.version.number="4.0.0",
       ssphp.use_case.version.last_changed_date="2023-10-18",
       ssphp.use_case.version.last_changed_by="Ian Pearl",
       ssphp.score.threshold.red="-",
       ssphp.score.threshold.orange="-",
       ssphp.score.threshold.green="99",
       ssphp.score.color=case('ssphp.score.score'>'ssphp.score.threshold.green',"green",1==1,"red"),
       ssphp.score.scoring_narrative="Score is calculated as the weighted average of all the constituent scores, with the weighting based in Impact and Likelihood : ".mvjoin('use_case',", ").". Best=100, Worst=0"


`ssphp_use_case_write`

"""
