[ssphp_use_case_azure_001_cis_1-2-3]
cron_schedule = */30 * * * *
dispatch.earliest_time = 0
dispatch.latest_time = now
enableSched = 1
search = """
| `ssphp_use_case_aad_001`

| eval foundational_system="aad", type="plan"
| lookup ssphp_acceptable_policy_list.csv foundational_system, type output acceptable_policy_key
| fields - foundational_system, type

| stats count as total_number_accounts,
        sum(eval(if(isPrivileged="true",1,0))) as number_privileged_accounts,
        sum(eval(if(isPrivileged="true" AND like(conditionalAccessPlans_key,acceptable_policy_key),1,0))) as number_privileged_accounts_mfa_enabled


| eval ssphp.score.numerator=number_privileged_accounts_mfa_enabled,
       ssphp.score.denominator=number_privileged_accounts,
       ssphp.score.score=round('ssphp.score.numerator'*100/'ssphp.score.denominator')
| fillnull value=0 ssphp.score.score
| fields ssphp.score.score, ssphp.score.numerator, ssphp.score.denominator


``` ##################### add metadata ##################### ```
| eval SSPHP_RUN=round(now()),
       ssphp.use_case.id="azure_001_cis_1-2-3",

       ssphp.use_case.version.number="2.0.0",
       ssphp.use_case.version.last_changed_date="2023-10-05",
       ssphp.use_case.version.last_changed_by="Ian Pearl",
       
       ssphp.microsoft.description=coalesce('description',"-"),
       ssphp.microsoft.implementation_status=coalesce('implementationStatus',"-")

| lookup foundational_systems_use_case_metadata.csv ssphp.use_case.id

| eval ssphp.use_case.control=coalesce('ssphp.use_case.control','ssphp.cis_benchmark.control.title',"-"),
       ssphp.use_case.description=coalesce('ssphp.use_case.description','ssphp.cis_benchmark.control.description',"-")

```
| eval SSPHP_RUN=round(now()),
       ssphp.use_case.id="azure_001_cis_1-2-3",
       ssphp.use_case.display.title="Azure 001 [CIS 1.2.3]",
       ssphp.use_case.display.short_description="MFA Policy for Admin Groups",

       ssphp.cis_benchmark.document.name="CIS Microsoft Azure Foundations Benchmark",
       ssphp.cis_benchmark.document.version="2.0.0",
       ssphp.cis_benchmark.document.date="14-02-2023",

       ssphp.cis_benchmark.control.number="1.2.3",
       ssphp.cis_benchmark.control.level="L1",
       ssphp.cis_benchmark.control.title="Ensure that A Multi-factor Authentication Policy Exists for Administrative Groups",
       ssphp.cis_benchmark.control.profile_applicability="Level 1",
       ssphp.cis_benchmark.control.description="For designated users, they will be prompted to use their multi-factor authentication (MFA) process on login",
       ssphp.cis_benchmark.control.rationale="Enabling multi-factor authentication is a recommended setting to limit the use of Administrative accounts to authenticated personnel.",
       ssphp.cis_benchmark.control.impact="There is an increased cost, as Conditional Access policies require Azure AD Premium. Similarly, MFA may require additional overhead to maintain. There is also a potential scenario in which the multi-factor authentication method can be lost, and administrative users are no longer able to log in. For this scenario, there should be an emergency access account. Please see References for creating this.",
       ssphp.cis_benchmark.controls.v8=mvappend(ssphp.cis_benchmark.controls.v8,
                                                "6.3 Require MFA for Externally-Exposed Applications",
                                                "6.4 Require MFA for Remote Network Access",
                                                "6.5 Require MFA for Administrative Access",
                                                "6.7 Centralize Access Control"),
       ssphp.cis_benchmark.controls.ig1="true",
       ssphp.cis_benchmark.controls.ig2="true",
       ssphp.cis_benchmark.controls.ig3="true",

       ssphp.use_case.description='ssphp.cis_benchmark.control.description',
       ssphp.use_case.control='ssphp.cis_benchmark.control.description'." : ".ssphp.cis_benchmark.control.rationale,

       ssphp.use_case.version="1.0.0",
       ssphp.use_case.last_changed.date="2023-10-02",
       ssphp.use_case.last_changed.by="Ian Pearl",
       ssphp.use_case.treshhold.red="-",
       ssphp.use_case.treshhold.orange="-",
       ssphp.use_case.treshhold.green="99",
       ssphp.color=case('ssphp.score.score'>'ssphp.use_case.treshhold.green',"green",1==1,"red"),
       ssphp.use_case.scoring_narrative="Score is the percentage of privieged accounts that have the MFA Service Plan enabled. Best=100, Worst=0",
       ssphp.use_case.framework.mitre="Initial Access",
       ssphp.use_case.framework.ig_1="6.4, 6.5",
       ssphp.use_case.framework.ig_2="6.3, 6.4, 6.5, 6.7",
       ssphp.use_case.framework.ig_3="6.3, 6.4, 6.5, 6.7"
```

`ssphp_use_case_write`

"""
