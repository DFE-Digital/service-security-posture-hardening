[ssphp_use_case_azure_001_cis_1-2-3]
cron_schedule = */30 * * * *
dispatch.earliest_time = 0
dispatch.latest_time = now
enableSched = 1
search = """
| `ssphp_use_case_m365_cis_powershell("SSPHP.AAD.conditional_access_policy")`

| fields id, displayName, state, conditions.users.includeGroups{}, conditions.clientAppTypes{}, grantControls.builtInControls{}

| eval ssphp.score.numerator=if(match('conditions.users.includeGroups{}',".*-47ee-.*") OR match('conditions.users.includeGroups{}',".*-91d1-.*"),1,0),
       ``` NOTE : the above condition uses guids that I surmised by looking at the data but these are inevitably not the actual guid of the admin groups.
           when it comes to finding the real guids that we need to be looking for then we will not be able to hard code them here (Github) so
           we will need to create a lookup in the private app and look in there```
       ssphp.score.numerator=if(upper('state')="ENABLED",'ssphp.score.numerator'+1,'ssphp.score.numerator'),
       ssphp.score.numerator=if(upper('conditions.clientAppTypes{}')="ALL",'ssphp.score.numerator'+1,'ssphp.score.numerator'),
       ssphp.score.numerator=if(upper('grantControls.builtInControls{}')="MFA",'ssphp.score.numerator'+1,'ssphp.score.numerator'),
       ssphp.score.denominator="4",
       ssphp.score.score=floor('ssphp.score.numerator'*100/'ssphp.score.denominator')

| stats max(ssphp.score.score) as ssphp.score.score, max(ssphp.score.numerator) as ssphp.score.numerator, max(ssphp.score.denominator) as ssphp.score.denominator

| fields ssphp.score.score, ssphp.score.numerator, ssphp.score.denominator


``` ##################### add metadata ##################### ```
| eval SSPHP_RUN=round(now()),
       ssphp.use_case.id="azure_001_cis_1-2-3",

       ssphp.use_case.version.number="1.0.0",
       ssphp.use_case.version.last_changed_date="2023-11-09",
       ssphp.use_case.version.last_changed_by="Ian Pearl",
       
       ssphp.microsoft.description=coalesce('description',"-"),
       ssphp.microsoft.implementation_status=coalesce('implementationStatus',"-")

`ssphp_use_case_add_cis_metadata`

| eval ssphp.use_case.control=coalesce('ssphp.use_case.control','ssphp.cis_benchmark.control.title',"-"),
       ssphp.use_case.description=coalesce('ssphp.use_case.description','ssphp.cis_benchmark.control.description',"-")

| eval ssphp.score.color=case('ssphp.score.score'>'ssphp.score.threshold.green',"green",1==1,"red")


`ssphp_use_case_write`

"""
