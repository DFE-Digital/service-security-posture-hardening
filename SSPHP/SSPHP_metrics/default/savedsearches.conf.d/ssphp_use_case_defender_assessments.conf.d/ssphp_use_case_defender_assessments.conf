[ssphp_use_case_defender_assessments]
cron_schedule = 30 3 * * *
dispatch.earliest_time = 0
dispatch.latest_time = now
enableSched = 1
search = """
index="ssphp_metrics_data" sourcetype="azure_resource_graph_TBD" type="microsoft.security/assessments*" earliest=-7d@d latest=now
     (subscriptionId="32591f22-8209-4c82-a65c-618b967e7bff" OR subscriptionId="e0af9630-5d6c-4e5c-9012-ffc8566e7990") resourceGroup="s194*"

    [| search index="ssphp_metrics_data" sourcetype="azure_resource_graph_TBD" type="microsoft.security/assessments*" earliest=-7d@d latest=now
                  (subscriptionId="32591f22-8209-4c82-a65c-618b967e7bff" OR subscriptionId="e0af9630-5d6c-4e5c-9012-ffc8566e7990") resourceGroup="s194*"
     | stats max(SSPHP_RUN) as SSPHP_RUN
     | return SSPHP_RUN]

`ssphp_add_service_metadata`

| regex id="^\/subscriptions\/.*\/"
| fields id, azure.tenant_id, azure.subscription_id, azure.resource_group_id, service.display_name, service.name, service.group, service.division, service.portfolio, tags, location, name, type, properties.resourceDetails.ResourceType, properties.resourceDetails.ResourceId, properties.resourceDetails.ResourceName, properties.displayName, properties.metadata.displayName, properties.metadata.categories{}, properties.metadata.remediationDescription, properties.metadata.severity, properties.metadata.threats{}, properties.status.code, properties.metadata.description, properties.status.firstEvaluationDate, properties.status.statusChangeDate, properties.metadata.tactics{}, properties.metadata.techniques{}

| rex field=id "[\s\S]*\/(?<ssphp_use_case_id>[\s\S]*)$"
| rename ssphp_use_case_id as ssphp.use_case.id
| eval ssphp.score.ciso_priority=case(lower('properties.metadata.severity')="high","1",
                                      lower('properties.metadata.severity')="medium","2",
                                      1==1,"3"),

       ssphp.use_case.title='ssphp.use_case.id',
       ssphp.use_case.foundational_system='service.name',
       ssphp.use_case.foundational_system_name='service.display_name',
       ssphp.defender_assessments.control.title='properties.displayName',
       ssphp.defender_assessments.control.description='properties.metadata.description',
       ssphp.defender_assessments.control.rationale=mvappend('properties.metadata.categories{}','properties.metadata.threats{}'),
       ssphp.defender_assessments.control.impact=replace('properties.metadata.remediationDescription',"<br>"," "),
       ssphp.use_case.savedsearch="ssphp_use_case_defender_assessments"

| eval SSPHP_RUN=round(now()),
       ssphp.use_case.version.number="1.0.0",
       ssphp.use_case.version.last_changed_date="2024-03-15",
       ssphp.use_case.version.last_changed_by="Ian Pearl",
       ssphp.risk.expectancy="5",
       ssphp.risk.impact="5",
       ssphp.score.threshold.green="99",
       ssphp.score.threshold.orange="-",
       ssphp.score.threshold.red="-"

| eval ssphp.score.scoring_narrative="In order to be compliant, all the resources marked as 'Unhealthy' must be remediated"

| eval ssphp.score.scoring_narrative="In order to be compliant, the Security Defaults policy must be enabled, so isEnabled != 'false'"

| fields SSPHP_RUN, ssphp.*, azure.resource_group_id, azure.subscription_id, azure.tenant_id, id, location, name, properties.displayName, properties.metadata.categories{}, properties.metadata.displayName, properties.metadata.remediationDescription, properties.metadata.severity, properties.metadata.tactics{}, properties.metadata.techniques{}, properties.metadata.threats{}, properties.resourceDetails.ResourceId, properties.resourceDetails.ResourceName, properties.resourceDetails.ResourceType, properties.status.code, properties.metadata.description, properties.status.firstEvaluationDate, properties.status.statusChangeDate, service.display_name, service.division, service.group, service.name, service.portfolio, type

```| table azure.tenant_id, azure.subscription_id, azure.resource_group_id, properties.resourceDetails.ResourceName, properties.status.code```

``` ##################### end dashboard query ##################### ```

| stats values(SSPHP_RUN) as SSPHP_RUN, list(azure.tenant_id) as azure.tenant_id, list(azure.subscription_id) as azure.subscription_id, list(azure.resource_group_id) as azure.resource_group_id, values(properties.resourceDetails.ResourceType) as properties.resourceDetails.ResourceType, list(properties.resourceDetails.ResourceName) as properties.resourceDetails.ResourceName, list(properties.resourceDetails.ResourceId) as properties.resourceDetails.ResourceId, list(properties.status.code) as properties.status.code, values(ssphp.*) as ssphp.*```, values(*) as *``` by service.name, ssphp.use_case.id

| eval ssphp.score.numerator=coalesce(mvcount(mvfilter(match('properties.status.code',"Unhealthy"))),"0"),
       ssphp.score.denominator=coalesce(mvcount('properties.status.code'),"0"),
       ssphp.score.score=floor(('ssphp.score.denominator'-'ssphp.score.numerator')*100/'ssphp.score.denominator'),
       ssphp.score.color=case('ssphp.score.score'>'ssphp.score.threshold.green',"green",1==1,"red")

`ssphp_use_case_write`

"""
