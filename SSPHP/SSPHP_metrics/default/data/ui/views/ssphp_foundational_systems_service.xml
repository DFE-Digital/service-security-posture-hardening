<dashboard version="1.1" theme="dark" script="js/table_cell_color.js">
  <label>Security Posture Continuous Assurance : Service Dashboard</label>
  <description>v1.0.2</description>
  
  <init>
    <set token="tkn_selected_service_name"></set>
    <set token="tkn_selected_service"></set>
    <set token="tkn_controls_compliant_text"></set>

    <set token="tkn_colour_red">#D32D41</set>
    <set token="tkn_colour_orange">#EA6A47</set>
    <set token="tkn_colour_green">#B3C100</set>
    <set token="tkn_colour_green">#6AB187</set>
    <set token="tkn_colour_blue">#A5D8DD</set>
  </init>


<!-- ################### Set Target Service and other Tokens ################### --> 

  <row depends="$never_show$">
    <panel>
      <table>
        <search>
          <query>
| makeresults
| eval tkn_selected_service_name=upper($tkn__service|s$),
       tkn_selected_service=lower($tkn__service|s$)
| table tkn_selected_service_name, tkn_selected_service
          </query>
          <done>
            <set token="tkn_selected_service_name">$result.tkn_selected_service_name$</set>
            <set token="tkn_selected_service">$result.tkn_selected_service$</set>
          </done>
        </search>
      </table>
    </panel>
    
    <panel>
      <table>
        <search>
          <query>
  | makeresults
  | eval app=$env:app|s$
  | table app
          </query>
          <done>
            <set token="tkn_current_app">$result.app$</set>
          </done>
        </search>
      </table>
    </panel>
  </row>
  
  

<!-- ################### Summary Row ################### --> 

  <row>
    <panel>
      <html>
        <div id="div_header" style="background:$tkn_controls_compliant_text_colour$;color:white;font-weight:bold;font-size:800%;text-align:center;padding:50">$tkn_controls_compliant_text$</div> 
        <div id="div_header" style="background:$tkn_controls_compliant_text_colour$;color:white;font-size:100%;text-align:center">$tkn_selected_service_name$ Compliant / # DfE Mandated Controls</div> 
      </html>
    </panel>
  </row>



<!-- ################### Main Data Table Filters ################### --> 

  <row>
    <panel>
      <html>
        <div id="div_header" style="font-size:120%">$tkn_selected_service_name$ - Control Details &amp; Scores [$tkn_controls_total$]</div> 
      </html>
    </panel>
    <panel>
      <input type="checkbox" token="tkn_fields" searchWhenChanged="true">
        <label>Show Only</label>
        <choice value="N">Non-Compliant</choice>
        <choice value="C">DfE Mandated</choice>
        <initialValue>N,C</initialValue>
        <default>*</default>
      </input>
    </panel>
    
<!-- Search to build filter text --> 
    <panel depends="$never_show$">
      <table>
        <search>
          <query>
| makeresults
| eval txt1="| where match('Compliance Status',\"^Non-Compliant.*\")",
       txt2="| where 'DfE Mandated'=\"1\"",
       infield=$tkn_fields|s$,
       
       C=if(like(infield,"%C%"),'txt2'," "),
       N=if(like(infield,"%N%"),'txt1'," "),
       search='C'.'N'

| table txt1, txt2, search, C, N, infield
          </query>
          <done>
            <set token="tkn_search_filter">$result.search$</set>
          </done>
        </search>
      </table>
    </panel>
  </row>
  

<!-- ################### Main Data Table ################### --> 

  <row depends="$never_show$">
    <html>
      <style>
         .css_for_green{ 
         background-color: $tkn_colour_green$ !important;
         color:#000000 !important;
         font-size: 100% !important;
         }
         .css_for_orange{ 
         background-color: $tkn_colour_orange$ !important;
         color:#000000 !important;
         font-size: 100% !important;
         }
         .css_for_red{
         background-color: $tkn_colour_red$ !important;
         color:#000000 !important;
         font-size: 100% !important;
         }
         .css_for_blue{
         background-color: $tkn_colour_blue$ !important;
         font-size: 100% !important;
         }
      </style>
    </html>
    <html>
      <style>
        #table1 th:nth-child(1) {
          width: 150px;
        }
        #table1 th:nth-child(2) {
          width: 50px;
        }
        #table1 th:nth-child(3) {
          width: 100px;
        }
        #table1 th:nth-child(4) {
          width: 50px;
        }
      </style>
    </html>
  </row>

  <row>
    <panel>
      <table id="table1">
        <search>
          <query>
index="ssphp_metrics_summary" 
      ssphp.use_case.id="$tkn_selected_service$*" 
      ssphp.use_case.id!="*_000"
      ssphp.score.ciso_priority!="-"

      [| search index="ssphp_metrics_summary" ssphp.use_case.id="$tkn_selected_service$*" ssphp.use_case.id!="*_000"
        | stats max(SSPHP_RUN) as SSPHP_RUN by ssphp.use_case.id
        | eval search_text="(\"ssphp.use_case.id\"=\"".'ssphp.use_case.id'."\" AND SSPHP_RUN=\"".SSPHP_RUN."\")"
        | stats values(search_text) as search_text
        | eval search_text="(".mvjoin(search_text," OR ").")"
        | return $search_text]


| eval Score='ssphp.score.score'."|".'ssphp.score.color',
       ssphp.cis_benchmark.controls.v8=split('ssphp.cis_benchmark.controls.v8',"
 "),
       ssphp.use_case.description=coalesce('ssphp.use_case.description','ssphp.cis_benchmark.control.description')
 
| search Score=*
 

 ``` Eliminate all the Use Cases which have a current status set to "exclude" ```
| join type=outer ssphp.use_case.id
     [| search index="ssphp_metrics_summary" ssphp.type="exclusion" earliest=0 latest=now
      | sort 0 - SSPHP_RUN
      | eval ssphp.dfe_benchmark.exclusion.status=case('ssphp.dfe_benchmark.exclusion.status'="TRUE","exclude",
                                                       'ssphp.dfe_benchmark.exclusion.status'="FALSE","include",
                                                       1==1,'ssphp.dfe_benchmark.exclusion.status'),
        ssphp.dfe_benchmark.exclusion.updated=strftime(SSPHP_RUN,"%Y-%m-%d %H:%M:%S")
      | stats list(ssphp.dfe_benchmark.exclusion.*) as *, max(ssphp.dfe_benchmark.exclusion.updated) as last_updated by ssphp.use_case.id
      | eval current_status=mvindex(status,mvfind(updated,'last_updated'))
      | sort 0 ssphp.use_case.id
      | fields ssphp.use_case.id, current_status]
 
| fillnull value="include" current_status
| search current_status="*"

 
 ``` Is this use case compliant ```
| eval "Compliance Status"=if('ssphp.score.score'=100,"Compliant","Non-Compliant"),
        "Compliance Status"='Compliance Status'."|".'ssphp.score.color'


| table ssphp.use_case.id, ssphp.use_case.title, Score, "Compliance Status", ssphp.score.ciso_priority, ssphp.cis_benchmark.control.title, ssphp.use_case.description, ssphp.cis_benchmark.control.level, ssphp.cis_benchmark.controls.ig1, current_status, ssphp.score.color
 
| rename  ssphp.use_case.title as "Title",
          ssphp.use_case.description as "Description",
          ssphp.cis_benchmark.control.title as "Control Title",
          ssphp.cis_benchmark.control.level as "Level",
          current_status as "Exclusion Status",
          ssphp.cis_benchmark.controls.ig1 as "IG1 Status",
          ssphp.score.ciso_priority as "DfE Mandated",
          ssphp.score.color as Colour
          
| sort 0 ssphp.use_case.id
 

 ``` sort the lines properly ```
| rex field=ssphp.use_case.id "^$tkn_selected_service$_00[0-9]{1}_cis_(?&lt;n1&gt;[^-]*)-(?&lt;n2&gt;[^-]*)"
| rex field=ssphp.use_case.id "^$tkn_selected_service$_00[0-9]{1}_cis_[^-]*-[^-]*-(?&lt;n3&gt;.*)$"
| fillnull value=0 n3
| eval n2="00".n2, n2=substr(n2,len(n2)-1,2),
       n3="00".n3, n3=substr(n3,len(n3)-1,2), 
       sort_field='n1'.'n2'.'n3'
| sort 0 "DfE Mandated", sort_field
| fields - sort_field, n1, n2, n3
 

| eventstats count as number_controls_total, 
             sum(eval(if('DfE Mandated'=1,1,0))) as number_controls_ciso_1, 
             sum(eval(if('DfE Mandated'=1 AND match('Compliance Status',"^Compliant\|.*"),1,0))) as number_controls_compliant, 
             sum(eval(if('DfE Mandated'=1 AND match('Compliance Status',"^Non-Compliant\|.*"),1,0))) as number_controls_non_compliant

| eval number_controls_compliant_text='number_controls_compliant'." / ".'number_controls_ciso_1',
       number_controls_compliant_text_colour=if('number_controls_ciso_1'='number_controls_compliant',"$tkn_colour_green$","$tkn_colour_red$")



``` Dashboard Filters
| where match('Compliance Status',"^Non-Compliant.*")
| where 'DfE Mandated'="1"```
$tkn_search_filter$
          </query>
          <latest>now</latest>
          <earliest>-1d@d</earliest>
          <sampleRatio>1</sampleRatio>
          <done>
            <set token="tkn_controls_total">$result.number_controls_total$</set>
            <set token="tkn_controls_ciso">$result.number_controls_ciso_1$</set>
            <set token="tkn_controls_compliant">$result.number_controls_compliant$</set>
            <set token="tkn_controls_non_compliant">$result.number_controls_non_compliant$</set>
            <set token="tkn_controls_compliant_text">$result.number_controls_compliant_text$</set>
            <set token="tkn_controls_compliant_text_colour">$result.number_controls_compliant_text_colour$</set>
          </done>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <fields>"Title", Score, "Compliance Status", "DfE Mandated", "Control Title", "Description"</fields>
        <option name="drilldown">row</option>
        <drilldown>
          <link target="_blank">/app/$tkn_current_app$/ssphp_foundational_systems_detail_cis?tkn_use_case_id=$row.ssphp.use_case.id$</link>
        </drilldown>
      </table>
    </panel>
  </row>
</dashboard>