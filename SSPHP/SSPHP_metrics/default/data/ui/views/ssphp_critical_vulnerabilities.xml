<form version="1.1" theme="dark">
  <label>Vulnerability Management</label>
  <description>v1.1.0</description>
  
  
  <search id="bs_1">
    <query>
| loadjob savedsearch="nobody:SSPHP_metrics:ssphp_vulnerabilities_create_data"
| table *
    </query>
  </search>
  
  
  <fieldset submitButton="false">
    <input type="text" token="tkn_search_text" searchWhenChanged="true">
      <label>Ownership Search Text (Regex)</label>
      <default>.*</default>
      <initialValue>.*</initialValue>
    </input>
  </fieldset>
  
  
  <row>
    <panel>
      <title>Vulnerabilities older than 400 days and severity 5 [$tkn_event_count$]</title>
      <table>
        <search base="bs_1">
          <query>
| eval search_text=$tkn_search_text|s$,
       search_text=lower('search_text'),
       search_text=".*".'search_text'.".*"
| where match('ownership','search_text')

| eval sortval=mvcount('TITLE')
| sort 0 - sortval
| eventstats count as event_count
          </query>
          <done>
            <set token="tkn_event_count">$result.event_count$</set>
          </done>
        </search>
        <option name="count">5</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <fields>["HOST_ID","ownership","TITLE","VULNERABILITY_AGE"]</fields>
        <drilldown>
          <condition field="TITLE">
            <set token="tkn_hostname">$row.HOST_ID$</set>
            <set token="tkn_title">$click.value2$</set>
          </condition>
          <condition>
            <set token="tkn_title">$row.HOST_ID$</set>
          </condition>
        </drilldown>
      </table>
    </panel>
  </row>
  
  
  
  <row>
    <panel>
      <title>Details for CVE=$tkn_title$</title>
      <table>
        <search base="bs_1">
          <query>
| search HOST_ID=$tkn_hostname$
| eval searchtext=replace($tkn_title|s$, "\(", "\\("),
       searchtext=replace('searchtext', "\)", "\\)"),
       pointer=mvfind('TITLE', 'searchtext')
| eval TITLE=mvindex('TITLE', 'pointer'),
       SOLUTION=mvindex('SOLUTION', 'pointer'),
       CONSEQUENCE=mvindex('CONSEQUENCE', 'pointer'),
       DIAGNOSIS=mvindex('DIAGNOSIS', 'pointer')
| table TITLE, SOLUTION, CONSEQUENCE, DIAGNOSIS
| transpose
| rename column as FIELD, "row 1" as DESCRIPTION

          </query>
          <done>
            <set token="tkn_event_count">$result.event_count$</set>
          </done>
        </search>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
    
    <panel>
      <title>Ownership for HOST_ID=$tkn_hostname$</title>
      <table>
        <search base="bs_1">
          <query>
| search HOST_ID=$tkn_hostname$

| fields shortname, tags.* 

| lookup ssphp_business_service_index.csv "Service ID" as shortname
| rename tags.* as *
| transpose 
| rename column as TAG, "row 1" as VALUE
| eval VALUE=split('VALUE',"~~~")
| where isnotnull('VALUE')
          </query>
          <done>
            <set token="tkn_event_count">$result.event_count$</set>
          </done>
        </search>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
</form>