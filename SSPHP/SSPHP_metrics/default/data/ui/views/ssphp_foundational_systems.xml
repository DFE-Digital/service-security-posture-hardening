<dashboard version="1.1" theme="dark" script="table_cell_color.js">
  <label>Foundational Systems Security Posture</label>
  <description>v1.14</description>
  
  <init>
    <set token="tkn_selected_system">*</set>
    <set token="tkn_selected_system_name">Overall</set>
    <unset token="tkn_selected_system_m365"></unset>
  </init>



<!-- ################### Overall Rollup Panel ################### --> 

  <row>
    <panel>
      <single>
        <title>Overall</title>
        <search>
          <query>
            `ssphp_metrics_index` ssphp.use_case.id="*_000" earliest=-2d@d latest=now
            [| search `ssphp_metrics_index` ssphp.use_case.id="*_000" earliest=-2d@d latest=now
             | stats max(SSPHP_RUN) as SSPHP_RUN by ssphp.use_case.id
             | eval search_text="(\"ssphp.use_case.id\"=\"".'ssphp.use_case.id'."\" AND SSPHP_RUN=\"".SSPHP_RUN."\")"
             | stats values(search_text) as search_text
             | eval search_text="(".mvjoin(search_text," OR ").")"
             | return $search_text]
        | regex ssphp.use_case.id="^[^_]*_[^_]*$"
        | fields ssphp.use_case.id, ssphp.score.score, ssphp.color
        | sort 0 ssphp.use_case.id
        | eval aad_score=if('ssphp.use_case.id'="aad_000",'ssphp.score.score',""), aad_color=if('ssphp.use_case.id'="aad_000",'ssphp.color',""),
               azure_score=if('ssphp.use_case.id'="azure_000",'ssphp.score.score',""), azure_color=if('ssphp.use_case.id'="azure_000",'ssphp.color',""),
               dns_score=if('ssphp.use_case.id'="dns_000",'ssphp.score.score',""), dns_color=if('ssphp.use_case.id'="dns_000",'ssphp.color',""),
               m365_score=if('ssphp.use_case.id'="m365_000",'ssphp.score.score',""), m365_color=if('ssphp.use_case.id'="m365_000",'ssphp.color',"")
        | stats values(aad_score) as aad_score,
                values(azure_score) as azure_score,
                values(dns_score) as dns_score,
                values(m365_score) as m365_score,
                values(aad_color) as aad_color,
                values(azure_color) as azure_color,
                values(dns_color) as dns_color,
                values(m365_color) as m365_color
        | eval overall_score=floor(avg(aad_score, azure_score, dns_score, m365_score)),
               overall_color=if(overall_score&gt;99,"green","red")
        | table overall_score, overall_color, aad_score, aad_color, azure_score, azure_color, dns_score, dns_color, m365_score, m365_color
          </query>
        </search>
        <drilldown>
          <set token="tkn_selected_system">*</set>
          <set token="tkn_selected_system_name">Overall</set>
          <unset token="tkn_selected_system_m365"></unset>
        </drilldown>
        <option name="drilldown">all</option>
        <option name="colorMode">block</option>
        <option name="height">$data_panel_height$</option>
        
        <option name="rangeColors">[$tkn_dns_rollup_colour$,$tkn_dns_rollup_colour$]</option>
        <option name="rangeValues">[0]</option>
        <option name="useColors">1</option>
      </single>
    </panel>
  </row>



<!-- ################### Rolled Up Panels for each Foundational System ################### --> 

  <row>
    <panel>
      <single>
        <title>Azure</title>
        <search>
          <query>
  `ssphp_metrics_index` ssphp.use_case.id="azure_000" earliest=-2d@d latest=now
      [| search `ssphp_metrics_index` ssphp.use_case.id="azure_000" earliest=-2d@d latest=now
       | stats max(SSPHP_RUN) as SSPHP_RUN
       | return SSPHP_RUN]
  | fields _time, ssphp.use_case.id, ssphp.use_case.display.title, ssphp.score.score, ssphp.color
  | rename ssphp.use_case.display.title as Title, ssphp.score.score as Score, ssphp.color as Colour
  | table Score, Colour
          </query>
        </search>
        <drilldown>
          <set token="tkn_selected_system">azure</set>
          <set token="tkn_selected_system_name">AZURE</set>
          <unset token="tkn_selected_system_m365"></unset>
        </drilldown>
        <option name="drilldown">all</option>
        <option name="colorMode">block</option>
        <option name="height">$data_panel_height$</option>
        <option name="rangeColors">[$tkn_dns_rollup_colour$,$tkn_dns_rollup_colour$]</option>
        <option name="rangeValues">[0]</option>
        <option name="useColors">1</option>
      </single>
    </panel>

    <panel>
      <single>
        <title>Azure Active Directory</title>
        <search>
          <query>
  `ssphp_metrics_index` ssphp.use_case.id="aad_000" earliest=-2d@d latest=now
      [| search `ssphp_metrics_index` ssphp.use_case.id="aad_000" earliest=-2d@d latest=now
       | stats max(SSPHP_RUN) as SSPHP_RUN
       | return SSPHP_RUN]
  | fields _time, ssphp.use_case.id, ssphp.use_case.display.title, ssphp.score.score, ssphp.color
  | rename ssphp.use_case.display.title as Title, ssphp.score.score as Score, ssphp.color as Colour
  | table Score, Colour
          </query>
        </search>
        <drilldown>
          <set token="tkn_selected_system">aad</set>
          <set token="tkn_selected_system_name">AAD</set>
          <unset token="tkn_selected_system_m365"></unset>
        </drilldown>
        <option name="drilldown">all</option>
        <option name="colorMode">block</option>
        <option name="height">$data_panel_height$</option>
        <option name="rangeColors">[$tkn_dns_rollup_colour$,$tkn_dns_rollup_colour$]</option>
        <option name="rangeValues">[0]</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    
    <panel>
      <single>
        <title>DNS</title>
        <search>
          <query>
  `ssphp_metrics_index` ssphp.use_case.id="dns_000" earliest=-2d@d latest=now
      [| search `ssphp_metrics_index` ssphp.use_case.id="aad_000" earliest=-2d@d latest=now
       | stats max(SSPHP_RUN) as SSPHP_RUN
       | return SSPHP_RUN]
  | fields _time, ssphp.use_case.id, ssphp.use_case.display.title, ssphp.score.score, ssphp.color
  | rename ssphp.use_case.display.title as Title, ssphp.score.score as Score, ssphp.color as Colour
  | table Score, Colour
          </query>
        </search>
        <drilldown>
          <set token="tkn_selected_system">dns</set>
          <set token="tkn_selected_system_name">DNS</set>
          <unset token="tkn_selected_system_m365"></unset>
        </drilldown>
        <option name="drilldown">all</option>
        <option name="colorMode">block</option>
        <option name="height">$data_panel_height$</option>
        <option name="rangeColors">[$tkn_dns_rollup_colour$,$tkn_dns_rollup_colour$]</option>
        <option name="rangeValues">[0]</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    
    <panel>
      <single>
        <title>M365</title>
        <search>
          <query>
  `ssphp_metrics_index` ssphp.use_case.id="m365_000" earliest=-2d@d latest=now
      [| search `ssphp_metrics_index` ssphp.use_case.id="aad_000" earliest=-2d@d latest=now
       | stats max(SSPHP_RUN) as SSPHP_RUN
       | return SSPHP_RUN]
  | fields _time, ssphp.use_case.id, ssphp.use_case.display.title, ssphp.score.score, ssphp.color
  | rename ssphp.use_case.display.title as Title, ssphp.score.score as Score, ssphp.color as Colour
  | table Score, Colour
          </query>
        </search>
        <drilldown>
          <set token="tkn_selected_system">m365</set>
          <set token="tkn_selected_system_name">M365</set>
          <set token="tkn_selected_system_m365">m365</set>
        </drilldown>
        <option name="drilldown">all</option>
        <option name="colorMode">block</option>
        <option name="height">$data_panel_height$</option>
        <option name="rangeColors">[$tkn_dns_rollup_colour$,$tkn_dns_rollup_colour$]</option>
        <option name="rangeValues">[0]</option>
        <option name="useColors">1</option>
      </single>
    </panel>
  </row>



<!-- ################### M365 Sub Rollups ################### --> 

  <row depends="$tkn_selected_system_m365$">
    <panel>
      <table id="table1">
        <search>
          <query>
  `ssphp_metrics_index` ssphp.use_case.id="m365_*_000" earliest=-2d@d latest=now
    [| search `ssphp_metrics_index` ssphp.use_case.id="m365_*_000" earliest=-2d@d latest=now
      | stats max(SSPHP_RUN) as SSPHP_RUN by ssphp.use_case.id
      | eval search_text="(\"ssphp.use_case.id\"=\"".'ssphp.use_case.id'."\" AND SSPHP_RUN=\"".SSPHP_RUN."\")"
      | stats values(search_text) as search_text
      | eval search_text="(".mvjoin(search_text," OR ").")"
      | return $search_text]
      
| rex field=ssphp.use_case.id "m365_(?&lt;uc&gt;[^_]*)_000"
| eval uc_desc=case(uc="001","Account &amp; Authentication",
                    uc="002","Application Permissions",
                    uc="003","Data Management",
                    uc="004","EMail Security / Exchange Online",
                    uc="005","Auditing",
                    uc="006","Storage"),
       ssphp.use_case.id="M365 ".uc." : ".uc_desc

| stats values(ssphp.score.score) as score, values(ssphp.color) as color by ssphp.use_case.id
| eval score=score."|".color
| fields ssphp.use_case.id, score

| eval {ssphp.use_case.id}=score
| stats values(*) as *
| fields - score, ssphp.use_case.id
          </query>
          <earliest>0</earliest>
          <latest>now</latest>
          <sampleRatio>1</sampleRatio>
        </search>
      </table>
    </panel>
  </row>



<!-- ################### Main Data Table ################### --> 

  <row depends="$never_show$">
    <html>
      <style>
         .css_for_green{ 
         background-color:#00FF00 !important;
         color:#000000 !important;
         font-size: 150% !important;
         }
         .css_for_orange{ 
         background-color:#d94e17 !important;
         color:#000000 !important;
         font-size: 150% !important;
         }
         .css_for_red{
         background-color:#FF0000 !important;
         color:#000000 !important;
         font-size: 150% !important;
         }
         .css_for_blue{
         background-color:#0000FF !important;
         }
      </style>
    </html>
  </row>

  <row>
    <panel depends="$never_show$">
      <table>
        <search>
          <query>
  | makeresults
  | eval app=$env:app|s$
  | table app
          </query>
          <done>
            <set token="tkn_current_app">$result.app$</set>
          </done>
        </search>
      </table>
    </panel>

    <panel>
      <title>$tkn_selected_system_name$ Control Details &amp; Scores</title>
      <table id="table2">
        <search>
          <query>
index="ssphp_metrics_summary" ssphp.use_case.id="$tkn_selected_system$*"
| dedup ssphp.use_case.id
| search ssphp.use_case.id!="*_000" AND ssphp.use_case.id!="*rollup*" AND ssphp.use_case.id!="m365_001" AND ssphp.use_case.id!="m365_002" AND ssphp.use_case.id!="*6_1" AND ssphp.use_case.id!="*6_2"

| eval Score='ssphp.score.score'."|".'ssphp.color'

| rename ssphp.use_case.display.title as "Title",
         ssphp.use_case.display.short_description as "Name",
         ssphp.use_case.description as "Description",
         ssphp.cis_benchmark.control.title as "Control Title"

| table "Title", Score, "Name", "Description", "Control Title", ssphp.use_case.id

| sort 0 Title
          </query>
          <earliest>0</earliest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <fields>"Title", Score, "Name", "Description", "Control Title", ssphp.use_case.id</fields>
        <option name="drilldown">row</option>
        <drilldown>
          <link target="_blank">/app/$tkn_current_app$/ssphp_foundational_systems_drilldown?tkn_use_case_id=$row.ssphp.use_case.id$</link>
        </drilldown>
      </table>
    </panel>
  </row>
</dashboard>