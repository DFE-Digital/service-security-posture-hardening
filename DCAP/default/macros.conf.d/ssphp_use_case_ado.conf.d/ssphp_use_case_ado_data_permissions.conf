[ssphp_use_case_ado_data_permissions{{environment}}]

definition = """

index=*data* sourcetype=ado source=*access* ```token=*repov2* token=repoV2/a7487b64-fb55-478b-8f16-c8136f577ffa/f58ced63-2c89-4a82-a091-af952d0efc98```  1743076360 acesVec ```token=repoV2/5f12ae46-c945-4639-a4bf-2dbd7f365d65 OR token=repoV2/5f12ae46-c945-4639-a4bf-2dbd7f365d65/035bd7ce-56c7-49d2-9665-e9abc4b426eb```

| rex field=source "accesscontrollists/(?<namespaceId>[^/?]+)\?" 
| rename acesVec{}.descriptor as descriptor, acesVec{}.allow as allow, acesVec{}.deny as deny, acesVec{}.extendedInfo.effectiveAllow as effectiveAllow, acesVec{}.extendedInfo.effectiveDeny as effectiveDeny 
| fields token namespaceId descriptor allow deny effectiveAllow effectiveDeny 

| eval mashed=mvzip(mvzip(mvzip(mvzip('descriptor','allow',"~~"),'deny',"~~"), 'effectiveAllow', "~~"), 'effectiveDeny', "~~") 
| fields token namespaceId, mashed - _raw _time 

| mvexpand mashed 
| eval descriptor=mvindex(split('mashed',"~~"),0),
    allow=mvindex(split('mashed',"~~"),1),
    deny=mvindex(split('mashed',"~~"),2),
    effectiveAllow=mvindex(split('mashed',"~~"), 3),
    effectiveDeny=mvindex(split('mashed',"~~"), 4) 
| fields - mashed 

| lookup ak_ado_namespaces_actions.csv namespaceId 
| lookup ak_ado_identities.csv descriptor 

| foreach mode=multivalue bit 
    [ eval effectiveAllow_bit=bit_and(<<ITEM>>, 'effectiveAllow'),
        effectiveDeny_bit=bit_and(<<ITEM>>, 'effectiveDeny'),
        allow_bit=bit_and(<<ITEM>>, 'allow'),
        deny_bit=bit_and(<<ITEM>>, 'deny'),
        effectiveAllow_actions=mvappend('effectiveAllow_actions', if('effectiveAllow_bit'>0, mvindex('actionName', <<ITER>>), null())),
        effectiveDeny_actions=mvappend('effectiveDeny_actions', if('effectiveDeny_bit'>0, mvindex('actionName', <<ITER>>), null()))
        ```allowed_actions=mvappend('allowed_actions', if('allow_bit'>0, mvindex('actionName', <<ITER>>), null())),
        denied_actions=mvappend('denied_actions', if('deny_bit'>0, mvindex('actionName', <<ITER>>), null()))```
        ] 
| fields - allow_bit deny_bit effectiveAllow_bit effectiveDeny_bit effectiveAllow effectiveDeny descriptor
    ```| search token="repov2*" ```

| eval project_id=mvindex(split('token',"/"),1),
    repo_id=mvindex(split('token',"/"),2)
    ```organization_allowed_actions=if(isnull(project_id),'allowed_actions',null()),
    organization_denied_actions=if(isnull(project_id),'denied_actions',null()),
    project_allowed_actions=if(isnull(repo_id),'allowed_actions',null()),
    project_denied_actions=if(isnull(repo_id),'denied_actions',null()),
    repo_allowed_actions=if(isnotnull(repo_id),'allowed_actions',null()),
    repo_denied_actions=if(isnotnull(repo_id),'denied_actions',null()) 
| eventstats values(organization_allowed_actions) as organization_allowed_actions, values(organization_denied_actions) as organization_denied_actions 
| eventstats values(repo_id) as aaa by project_id 
| eval repo_id=coalesce('repo_id','aaa')```

| stats values(*) as * by token

```| fields - aaa allowed_actions denied_actions```

| search token="repov2/*/*" NOT token="repov2/*/*/*" 

| rename providerDisplayName as Actors
| table project_id repo_id Actors effective*_actions

| join type=outer ```organization,``` project_id, repo_id
    [| search index=SSPHP*data* sourcetype="ADO" source="*:https://dev.azure.com/*/*/_apis/git/repositories?api-version=*"
        [| search index=SSPHP*data* sourcetype="ADO" source="*:https://dev.azure.com/*/*/_apis/git/repositories?api-version=*"
        | stats max(SSPHP_RUN) as SSPHP_RUN
        | return SSPHP_RUN]
    | spath metadata.type
    | search metadata.type="fn git_repository_list"
    | rename id as repo_id, name as repo_name, defaultBranch as repo_default_branch, isDisabled as repo_isdisabled, isInMaintenance as repo_ismaintenance, project.* as project_*, metadata.organization as organization, metadata.tenant as tenant, url as repo_url, daysSinceLastCommit as repo_daysSinceLastCommit, mostRecentCommitDate as repo_mostRecentCommitDate
    | fields tenant, organization, project_id, project_name, project_revision, project_state, project_url, project_visibility, repo_id, repo_name, repo_default_branch, repo_isdisabled, repo_ismaintenance, repo_url, repo_daysSinceLastCommit, repo_mostRecentCommitDate ]

```====================================== MACRO ENDS HERE ======================================================================================```

"""
iseval = 0



