<dashboard version="1.1" theme="dark" hideFilters="true" script="js/route.js">
  <label>DCAP HOME</label>

    <row depends="$debug$">
        <panel>
            <table id="routing_table">
                <search>
                    <query>
| rest splunk_server=local /services/authentication/current-context
| rename roles as user_roles

```| eval user_roles="dfe_ssphp_service_user_m365"```

| fields username, user_roles
| mvexpand user_roles

| join type=outer user_roles
    [| makeresults format=csv data="user_roles, service, priority
                                    dfe_ssphp_service_user_m365, m365, 02
                                    dfe_ssphp_service_user_aad, aad, 03
                                    dfe_ssphp_service_user_aws, dns, 04
                                    dfe_ssphp_service_user_azure, azure, 05"]
| eval service=coalesce('service',"-"),
       priority=if('service'="-",99,'priority')
       
| rex field=user_roles "^dfe_ssphp_service_user_(?&lt;service_no&gt;\d*)$"

| eval priority=if(isnotnull(service_no),01,'priority')

| eval link_target=case(isnotnull(service_no),"/en-GB/app/{{app}}{{environment}}/ssphp_dfe_service_posture?tkn__service=".'service_no',
                        'user_roles'="dfe_ssphp_service_power","/en-GB/app/{{app}}{{environment}}/ssphp_dfe_service",
                        'service'="-","/en-GB/app/{{app}}{{environment}}/ssphp_foundational_systems_posture",
                        1==1,"/en-GB/app/{{app}}{{environment}}/ssphp_foundational_systems_service?form.tkn__service=".'service')

| sort 1 priority

| table link_target

                    </query>
                </search>
            </table>
        </panel>
    </row>

</dashboard>
