<dashboard version="1.1" theme="dark">

<label>DCAP Healthcheck Dashboard</label>
<description>_DEV v3.1.4</description>



  <!-- base search -->
  <search id="base_1">
    <query>
| rest /servicesNS/-/-/saved/searches splunk_server=local
| rename title as savedsearch_name
| fields savedsearch_name, cron_schedule, disabled, eai:acl.app

| stats values(*) as * by savedsearch_name

| rex field=cron_schedule "^(?&lt;cron_min&gt;[^ ]*) (?&lt;cron_hour&gt;[^ ]*) .*"
| eval cron_min=substr("00".'cron_min',len("00".'cron_min')-1),
       cron_hour=substr("00".'cron_hour',len("00".'cron_hour')-1),
       target_run_time='cron_hour'.":".'cron_min',
       outcome="bad",
       errors="not run"
| sort 0 target_run_time, savedsearch_name
| fields savedsearch_name, target_run_time, cron_schedule, disabled, eai:acl.app, outcome, errors

| join type=outer savedsearch_name
    [| search index=_internal (user="ssphp_app_account" OR user="nobody" OR user="*@education.gov.uk") savedsearch_name="ssphp*" earliest=$tkn_start_date$ latest=$tkn_end_date$

     | eval scheduled_time=strftime('scheduled_time',"%Y-%m-%d %H:%M:%S")
     | fields _time, savedsearch_name, savedsearch_id, app, start_time, run_time, scheduled_time, status, result_count, host, sid

     | stats min(_time) as start_time, max(_time) as completed_time, values(*) as * by sid

     | eval start_time=strftime('start_time',"%Y-%m-%d %H:%M:%S"),
            completed_time=strftime('completed_time',"%Y-%m-%d %H:%M:%S")

     | fillnull value=0 result_count, run_time
     | eventstats avg(run_time) as avg_run_time, avg(result_count) as avg_result_count by savedsearch_name
     | fillnull value=0 avg_run_time, avg_result_count

     | table savedsearch_name, savedsearch_id, app, scheduled_time, start_time, run_time, avg_run_time, avg_result_count, completed_time, result_count, status
     | sort 0 - scheduled_time

     | makemv errors
     | eval errors=if(run_time&lt;'avg_run_time'*$tkn_sensitivity_lower_run_time$,"run time too short",null()),
            errors=if(run_time>'avg_run_time'*$tkn_sensitivity_upper_run_time$,mvappend('errors',"run time too long"),'errors'),
            errors=if(result_count&lt;avg_result_count*$tkn_sensitivity_lower_result_count$,mvappend('errors',"result count too low"),'errors'),
            errors=if(result_count&gt;avg_result_count*$tkn_sensitivity_upper_result_count$,mvappend('errors',"result count too high"),'errors'),
            errors=if(like('status',"success"),'errors',mvappend('errors',"status not success")),
            errors=if(isnull('errors'),"-",'errors')


     | eval outcome=if(errors="-","good","bad")

     ```| search outcome="bad"```
     | eval run_date=substr('scheduled_time',0,10),
            target_date=strftime($tkn_date$,"%Y-%m-%d")
     | where run_date='target_date'

     | table avg_result_count, avg_run_time, completed_time, errors, outcome, result_count, run_date, run_time, savedsearch_name, scheduled_time, start_time, status, target_date, outcome]
     
| table target_date, run_date, savedsearch_name, eai:acl.app, disabled,
        outcome, errors, 
        result_count, avg_result_count,
        cron_schedule, target_run_time, scheduled_time,
        start_time, completed_time, run_time, avg_run_time,
        status
    </query>
    <earliest>0</earliest>
    <latest>now</latest>
    <sampleRatio>1</sampleRatio>
  </search>
  
  



  <row>
    <panel>
      <title>FBP Data Ingestion Age</title>
      <single>
        <search>
          <query>
`ssphp_metrics_data_index` sourcetype="financial_business_partners" earliest=-30d@d latest=now
| stats max(SSPHP_RUN) as SSPHP_RUN

| eval ssphp_run_age=round((now() - SSPHP_RUN)/60/60, 2)

| eval status=if(ssphp_run_age&lt;25,"Healthy","Unhealthy"),
       range=if('status'="Healthy","low","severe")
| table status, range
          </query>
        </search>

    <option name="drilldown">none</option>
    <option name="colorBy">value</option>
    <option name="colorMode">block</option>
    <option name="drilldown">none</option>
    <option name="numberPrecision">0</option>
    <option name="rangeColors">["0x65a637","0x6db7c6","0xf7bc38","0xf58f39","0xd93f3c"]</option>
    <option name="rangeValues">[0,30,70,100]</option>
    <option name="showSparkline">1</option>
    <option name="showTrendIndicator">1</option>
    <option name="trellis.enabled">0</option>
    <option name="trellis.scales.shared">1</option>
    <option name="trellis.size">medium</option>
    <option name="trendColorInterpretation">standard</option>
    <option name="trendDisplayMode">absolute</option>
    <option name="unitPosition">after</option>
    <option name="useColors">0</option>
    <option name="useThousandSeparators">1</option>
      </single>
    </panel>



    <panel>
      <title>Service Dashboard Loadjob Dataset</title>
      <single>
        <search base="base_bdmc">
          <query>
| eval key='ssphp.use_case.category'.'ssphp.service.portfolio'.'ssphp.service.service_line'.'ssphp.service.product'

| stats count, max(SSPHP_RUN) as SSPHP_RUN, dc(key) as no_key

| eval ssphp_run_age=round((now() - SSPHP_RUN)/60/60/24)

| eval status=if(count>300 AND ssphp_run_age&lt;1 AND no_key&gt;350 ,"Healthy","Unhealthy"),
       range=if('status'="Healthy","low","severe")
| table status, range
          </query>
        </search>

    <option name="drilldown">none</option>
    <option name="colorBy">value</option>
    <option name="colorMode">block</option>
    <option name="drilldown">none</option>
    <option name="numberPrecision">0</option>
    <option name="rangeColors">["0x65a637","0x6db7c6","0xf7bc38","0xf58f39","0xd93f3c"]</option>
    <option name="rangeValues">[0,30,70,100]</option>
    <option name="showSparkline">1</option>
    <option name="showTrendIndicator">1</option>
    <option name="trellis.enabled">0</option>
    <option name="trellis.scales.shared">1</option>
    <option name="trellis.size">medium</option>
    <option name="trendColorInterpretation">standard</option>
    <option name="trendDisplayMode">absolute</option>
    <option name="unitPosition">after</option>
    <option name="useColors">0</option>
    <option name="useThousandSeparators">1</option>
      </single>
    </panel>




    <panel>
      <title>Database Creation Sequence</title>
      <single>
        <search>
          <query>
| inputlookup ssphp_bdmc_fbp.csv
| stats max(SSPHP_RUN) as SSPHP_RUN_ssphp_bdmc_fbp

| append [| inputlookup ssphp_bdmc.csv
          | stats max(SSPHP_RUN) as SSPHP_RUN_ssphp_bdmc]
          
| append [| inputlookup ssphp_bdmc_resource_groups.csv
          | stats max(SSPHP_RUN) as SSPHP_RUN_ssphp_bdmc_resource_groups]
          
| append [| inputlookup ssphp_cost_centre_owner_emals.csv
          | stats max(SSPHP_RUN) as SSPHP_RUN_ssphp_cost_centre_owner_emals]
          
| stats values(*) as *

| makemv run_order
| foreach * 
    [| eval run_order=mvappend('run_order',strftime('&lt;&lt;FIELD&gt;&gt;',"%Y-%m-%d %H:%M:%S")." - "."&lt;&lt;FIELD&gt;&gt;")]
| eval run_order=mvsort('run_order')

| eval status=if(SSPHP_RUN_ssphp_cost_centre_owner_emals>'SSPHP_RUN_ssphp_bdmc_fbp' AND 
                 SSPHP_RUN_ssphp_bdmc_resource_groups&gt;'SSPHP_RUN_ssphp_bdmc_fbp' AND
                 SSPHP_RUN_ssphp_bdmc&gt;'SSPHP_RUN_ssphp_bdmc_resource_groups' AND
                 SSPHP_RUN_ssphp_bdmc&gt;'SSPHP_RUN_ssphp_bdmc_fbp' AND
                 SSPHP_RUN_ssphp_bdmc&gt;'SSPHP_RUN_ssphp_cost_centre_owner_emals',
                 "Healthy","Unhealthy"),
       range=if('status'="Healthy","low","severe")
| table status, range
          </query>
        </search>

    <option name="drilldown">none</option>
    <option name="colorBy">value</option>
    <option name="colorMode">block</option>
    <option name="drilldown">none</option>
    <option name="numberPrecision">0</option>
    <option name="rangeColors">["0x65a637","0x6db7c6","0xf7bc38","0xf58f39","0xd93f3c"]</option>
    <option name="rangeValues">[0,30,70,100]</option>
    <option name="showSparkline">1</option>
    <option name="showTrendIndicator">1</option>
    <option name="trellis.enabled">0</option>
    <option name="trellis.scales.shared">1</option>
    <option name="trellis.size">medium</option>
    <option name="trendColorInterpretation">standard</option>
    <option name="trendDisplayMode">absolute</option>
    <option name="unitPosition">after</option>
    <option name="useColors">0</option>
    <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    



    <panel>
      <title>FBP Database</title>
      <single>
        <search>
          <query>
| inputlookup ssphp_bdmc_fbp.csv

| table SSPHP_RUN,
        product_key,
        product_clean,
        id,
        cost_centre_code,
        account_code,
        activity_code,
        cost_centre_title,
        cost_centre_owner,
        financial_business_partner_email,
        hosting_provider_email,
        hosting_support_email,
        product_owner_email,
        portfolio,
        service_line,
        product
        
| stats count, max(SSPHP_RUN) as SSPHP_RUN, dc(product_key) as no_product_key

| eval ssphp_run_age=round((now() - SSPHP_RUN)/60/60)

| eval status=if(count&gt;350 AND ssphp_run_age&lt;24 AND count='no_product_key',"Healthy","Unhealthy"),
       range=if('status'="Healthy","low","severe")
| table status, range
          </query>
        </search>

    <option name="drilldown">none</option>
    <option name="colorBy">value</option>
    <option name="colorMode">block</option>
    <option name="drilldown">none</option>
    <option name="numberPrecision">0</option>
    <option name="rangeColors">["0x65a637","0x6db7c6","0xf7bc38","0xf58f39","0xd93f3c"]</option>
    <option name="rangeValues">[0,30,70,100]</option>
    <option name="showSparkline">1</option>
    <option name="showTrendIndicator">1</option>
    <option name="trellis.enabled">0</option>
    <option name="trellis.scales.shared">1</option>
    <option name="trellis.size">medium</option>
    <option name="trendColorInterpretation">standard</option>
    <option name="trendDisplayMode">absolute</option>
    <option name="unitPosition">after</option>
    <option name="useColors">0</option>
    <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    


    <panel>
      <title>Azure Asset Database</title>
      <single>
        <search>
          <query>
| inputlookup ssphp_bdmc.csv

| table SSPHP_RUN, resource_id, product_key

| stats count, max(SSPHP_RUN) as SSPHP_RUN, dc(product_key) as no_product_key

| eval ssphp_run_age=round((now() - SSPHP_RUN)/60/60)

| eval status=if(count>750000 AND ssphp_run_age&lt;24 AND no_product_key&gt;250,"Healthy","Unhealthy"),
       range=if('status'="Healthy","low","severe")
| table status, range
          </query>
        </search>

    <option name="drilldown">none</option>
    <option name="colorBy">value</option>
    <option name="colorMode">block</option>
    <option name="drilldown">none</option>
    <option name="numberPrecision">0</option>
    <option name="rangeColors">["0x65a637","0x6db7c6","0xf7bc38","0xf58f39","0xd93f3c"]</option>
    <option name="rangeValues">[0,30,70,100]</option>
    <option name="showSparkline">1</option>
    <option name="showTrendIndicator">1</option>
    <option name="trellis.enabled">0</option>
    <option name="trellis.scales.shared">1</option>
    <option name="trellis.size">medium</option>
    <option name="trendColorInterpretation">standard</option>
    <option name="trendDisplayMode">absolute</option>
    <option name="unitPosition">after</option>
    <option name="useColors">0</option>
    <option name="useThousandSeparators">1</option>
      </single>
    </panel>



    <panel>
      <title>Unassigned Qualys Vulnerabilities</title>
      <single>
        <search base="base_bdmc">
          <query>
| search ssphp.use_case.category="VULNERABILITY" AND ssphp.service.portfolio="Unassigned"

| stats count

| eval status=if(count&lt;100,"Healthy","Unhealthy"),
       range=if('status'="Healthy","low","severe")
| table status, range
          </query>
        </search>

    <option name="drilldown">none</option>
    <option name="colorBy">value</option>
    <option name="colorMode">block</option>
    <option name="drilldown">none</option>
    <option name="numberPrecision">0</option>
    <option name="rangeColors">["0x65a637","0x6db7c6","0xf7bc38","0xf58f39","0xd93f3c"]</option>
    <option name="rangeValues">[0,30,70,100]</option>
    <option name="showSparkline">1</option>
    <option name="showTrendIndicator">1</option>
    <option name="trellis.enabled">0</option>
    <option name="trellis.scales.shared">1</option>
    <option name="trellis.size">medium</option>
    <option name="trendColorInterpretation">standard</option>
    <option name="trendDisplayMode">absolute</option>
    <option name="unitPosition">after</option>
    <option name="useColors">0</option>
    <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    


    <panel>
      <title>Unassigned Defender Assessments</title>
      <single>
        <search base="base_bdmc">
          <query>
| search ssphp.use_case.category="POSTURE" AND ssphp.service.portfolio="Unassigned"

| stats count

| eval status=if(count&lt;100,"Healthy","Unhealthy"),
       range=if('status'="Healthy","low","severe")
| table status, range
          </query>
        </search>

    <option name="drilldown">none</option>
    <option name="colorBy">value</option>
    <option name="colorMode">block</option>
    <option name="drilldown">none</option>
    <option name="numberPrecision">0</option>
    <option name="rangeColors">["0x65a637","0x6db7c6","0xf7bc38","0xf58f39","0xd93f3c"]</option>
    <option name="rangeValues">[0,30,70,100]</option>
    <option name="showSparkline">1</option>
    <option name="showTrendIndicator">1</option>
    <option name="trellis.enabled">0</option>
    <option name="trellis.scales.shared">1</option>
    <option name="trellis.size">medium</option>
    <option name="trendColorInterpretation">standard</option>
    <option name="trendDisplayMode">absolute</option>
    <option name="unitPosition">after</option>
    <option name="useColors">0</option>
    <option name="useThousandSeparators">1</option>
      </single>
    </panel>
   
   
   

<!-- ######################################################### BASE QUERY ################################################################################################################# -->   
    
    <panel depends="$never_show$">
      <title>Service Dashboard Dataset</title>
      <table>
        <search id="base_bdmc">
          <query>
| loadjob savedsearch="ssphp_app_account:DCAP_DEV:ssphp_create_dashboard_dataset_service_DEV"

| table ssphp.service.portfolio, ssphp.service.service_line, ssphp.service.product, ssphp.assessment.source, ssphp.use_case.category, ssphp.use_case.id, ssphp.use_case.title, ssphp.assessment.display_name, ssphp.score.score, ssphp.score.compliance_status, ssphp.score.ciso_priority, ssphp.assessment.description, ssphp.score.color, ssphp.resource.id, ssphp.resource.tenant, ssphp.resource.subscription, ssphp.resource.resource_group, SSPHP_UID, SSPHP_RUN

          </query>
        </search>
      </table>
    </panel>
  </row>
  



  
  
  <row>
    <panel>
      <title>Sourcetype Data Update Timing</title>
      <single>
        <search>
          <query>
index="ssphp_metrics_data" earliest=-7d@d latest=now sourcetype!="data_ingester_rust"

| stats count as most_recent_count by sourcetype, SSPHP_RUN
| eventstats avg(most_recent_count) as avg_count, max(SSPHP_RUN) as most_recent_SSPHP_RUN by sourcetype
| where SSPHP_RUN='most_recent_SSPHP_RUN'
| eval avg_count=floor('avg_count'),
       most_recent_ingest_date_ingest=strftime('SSPHP_RUN',"%Y-%m-%d %H:%M:%S"),
       hours_since_ingest=floor((now()-most_recent_SSPHP_RUN)/60/60)
| table sourcetype, most_recent_SSPHP_RUN, most_recent_ingest_date_ingest, hours_since_ingest, most_recent_count, avg_count
| sort 0 - hours_since_ingest

| where hours_since_ingest&gt;24 OR most_recent_count&lt;('avg_count'*0.75) OR most_recent_count&gt;('avg_count'*1.5)

| append 
    [| makeresults]
    
| stats count

| eval status=if(count&lt;2,"Healthy","Unhealthy"),
       range=if('status'="Healthy","low","severe")
| table status, range
          </query>
        </search>

    <option name="drilldown">none</option>
    <option name="colorBy">value</option>
    <option name="colorMode">block</option>
    <option name="drilldown">none</option>
    <option name="numberPrecision">0</option>
    <option name="rangeColors">["0x65a637","0x6db7c6","0xf7bc38","0xf58f39","0xd93f3c"]</option>
    <option name="rangeValues">[0,30,70,100]</option>
    <option name="showSparkline">1</option>
    <option name="showTrendIndicator">1</option>
    <option name="trellis.enabled">0</option>
    <option name="trellis.scales.shared">1</option>
    <option name="trellis.size">medium</option>
    <option name="trendColorInterpretation">standard</option>
    <option name="trendDisplayMode">absolute</option>
    <option name="unitPosition">after</option>
    <option name="useColors">0</option>
    <option name="useThousandSeparators">1</option>
      </single>
    </panel>




    <panel>
      <title>Use Case Outputs</title>
      <single>
        <search>
          <query>
index=ssphp_metrics_summary_DEV earliest=-3d@d latest=now
| eval date=strftime('SSPHP_RUN',"%Y-%m-%d")
| eventstats max(SSPHP_RUN) as max_SSPHP_RUN by date, ssphp.use_case.savedsearch
| where SSPHP_RUN='max_SSPHP_RUN'


| fields SSPHP_RUN, date, ssphp.use_case.savedsearch
| eval days_since_start_of_time=SSPHP_RUN/24/60/60,
       today=now()/24/60/60,
       days_old=floor('today'-'days_since_start_of_time')
| table SSPHP_RUN, date, ssphp.use_case.savedsearch, days_since_start_of_time, today, days_old
| stats count by ssphp.use_case.savedsearch, days_old
| eval day_{days_old}='count'
| stats values(day_*) as day_* by ssphp.use_case.savedsearch
| where NOT ('day_0'&gt;('day_1'*0.9) OR 'day_0'&lt;('day_1'*1.1))
| rename day_0 as today, day_1 as yesterday
| table ssphp.use_case.savedsearch, today, yesterday

| append 
    [| makeresults]
    
| stats count

| eval status=if(count&lt;2,"Healthy","Unhealthy"),
       range=if('status'="Healthy","low","severe")
| table status, range
          </query>
        </search>

    <option name="drilldown">none</option>
    <option name="colorBy">value</option>
    <option name="colorMode">block</option>
    <option name="drilldown">none</option>
    <option name="numberPrecision">0</option>
    <option name="rangeColors">["0x65a637","0x6db7c6","0xf7bc38","0xf58f39","0xd93f3c"]</option>
    <option name="rangeValues">[0,30,70,100]</option>
    <option name="showSparkline">1</option>
    <option name="showTrendIndicator">1</option>
    <option name="trellis.enabled">0</option>
    <option name="trellis.scales.shared">1</option>
    <option name="trellis.size">medium</option>
    <option name="trendColorInterpretation">standard</option>
    <option name="trendDisplayMode">absolute</option>
    <option name="unitPosition">after</option>
    <option name="useColors">0</option>
    <option name="useThousandSeparators">1</option>
      </single>
    </panel>

  </row>



  <row>
    <panel>
      <html>
        <div>Failed SavedSearches &amp; Use Cases</div> 
      </html>
    </panel> 
  </row>


<row>
  <panel>
    <input type="dropdown" token="tkn_date" searchWhenChanged="true">
      <label>Date</label>
      <fieldForLabel>date</fieldForLabel>
      <fieldForValue>starttime</fieldForValue>
      <selectFirstChoice>true</selectFirstChoice>
      <search>
        <query>
| gentimes start=-30 end=1
| eval date=strftime('starttime',"%Y-%m-%d")
| sort 0 - date
| table date, starttime
        </query>
      </search>
    </input>
    
    <input type="radio" token="tkn_app" searchWhenChanged="true">
      <label>App</label>
      <choice value="DCAP">DCAP</choice>
      <choice value="DCAP_DEV">DCAP_DEV</choice>
      <default>DCAP</default>
    </input>
    
    <input type="radio" token="tkn_show" searchWhenChanged="true">
      <label>Show</label>
      <choice value="*">ALL</choice>
      <choice value="bad">Bad Only</choice>
      <default>bad</default>
    </input>
  </panel>
  
  <panel>
    <input type="text" token="tkn_sensitivity_lower_run_time" searchWhenChanged="true">
      <label>Run Time Lower Sensitivity</label>
      <default>.1</default>
    </input>
    
    <input type="text" token="tkn_sensitivity_upper_run_time" searchWhenChanged="true">
      <label>Run Time Upper Sensitivity</label>
      <default>10</default>
    </input>
    
    <input type="text" token="tkn_sensitivity_lower_result_count" searchWhenChanged="true">
      <label>Result Count Lower Sensitivity</label>
      <default>.1</default>
    </input>
    
    <input type="text" token="tkn_sensitivity_upper_result_count" searchWhenChanged="true">
      <label>Result Count Upper Sensitivity</label>
      <default>10</default>
    </input>
    
  </panel>
</row>

  
  <row depends="$debug$">
    <panel>
      <table>
        <search>
          <query>
| makeresults

| eval endtime=$tkn_date$,
       endtime='endtime'+(24*60*60)-1,
       starttime='endtime'-(30*24*60*60)
| table starttime, endtime
          </query>
          <done>
            <set token="tkn_start_date">$result.starttime$</set>
            <set token="tkn_end_date">$result.endtime$</set>
          </done>
        </search>
      </table>
    </panel>
  </row>
  
  
  
  <row>
    <panel>
      <title>SavedSearches [$tkn_count$]</title>
      <table>
        <search base="base_1">
          <query>
| search eai:acl.app=$tkn_app|s$ AND cron_schedule!="" AND disabled=0 AND outcome=$tkn_show$

| eventstats count
          </query>
          <done>
            <set token="tkn_count">$result.count$</set>
          </done>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <fields>target_date, savedsearch_name, eai:acl.app, disabled, outcome, errors, result_count, avg_result_count, cron_schedule, target_run_time, scheduled_time, start_time, completed_time, run_time, avg_run_time, status</fields>
      </table>
    </panel>
  </row>







  
</dashboard>