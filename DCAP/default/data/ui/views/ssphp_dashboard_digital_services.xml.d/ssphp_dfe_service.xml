<dashboard version="1.1" theme="dark" script="js/addtags.js, js/table_cell_color.js">

<label>Security Posture Continuous Assurance : DfE Service Dashboard</label>
<description>{{environment}} v4.1.18</description>
  
  <init>
    <set token="form.tkn_fields">C</set>
    <set token="tkn_controls_compliant_text"></set>
    <set token="tkn_font_size_1">900</set>
    <set token="tkn_font_size_2">400</set>
    <set token="tkn_padding_1">60</set>
    <set token="tkn_padding_2">30</set>
    <unset token="tkn_ready"></unset>


    <set token="tokHideAll">true</set>
    
    <set token="tkn_dashboard_start">1</set> 
  </init>


  <fieldset submitButton="false"></fieldset>
    


<!-- ######################################################################################################################################### -->
<!-- ########################################################## BASE SEARCHES ################################################################ -->
<!-- ######################################################################################################################################### -->

  <row depends="$debug$">
    <panel>
      <table>
        <search id="base_menu">
          <query>
| inputlookup ssphp_bdmc_fbp.csv where portfolio!="Unallocated"

| append [| makeresults
          | eval portfolio="Unassigned",
                 service_line="Unassigned",
                 product="Unassigned",
                 cost_centre_title="Unassigned"]
          </query>
        </search>
        <option name="count">1</option>
      </table>
    </panel>
    
<!-- #```| loadjob savedsearch="{{splunk_user}}:$tkn_current_app$:ssphp_create_dashboard_dataset_service{{environment}}"```# -->
    <panel>
      <table>
        <search id="bs_0">
          <query>
| loadjob savedsearch="ssphp_app_account:$tkn_current_app$:ssphp_create_dashboard_dataset_service{{environment}}"

| fields ssphp.service.portfolio, ssphp.service.service_line, ssphp.service.product, ssphp.assessment.source, ssphp.use_case.category, ssphp.use_case.id, ssphp.use_case.title, ssphp.assessment.display_name, ssphp.score.score, ssphp.score.compliance_status, ssphp.score.ciso_priority, ssphp.assessment.description, ssphp.score.color, ssphp.resource.id, ssphp.resource.tenant, ssphp.resource.subscription, ssphp.resource.subscription_name, ssphp.resource.resource_group, SSPHP_UID
          </query>
        </search>
        <option name="count">1</option>
      </table>
    </panel>


    <panel>
      <table>
        <search base="bs_0" id="bs_1">
          <query>
| search ssphp.service.portfolio=$tkn_portfolio|s$ AND ssphp.service.service_line=$tkn_service_line|s$ AND ssphp.service.product=$tkn_product|s$

| fields ssphp.service.portfolio, ssphp.service.service_line, ssphp.service.product, ssphp.assessment.source, ssphp.use_case.category, ssphp.use_case.id, ssphp.use_case.title, ssphp.assessment.display_name, ssphp.score.score, ssphp.score.compliance_status, ssphp.score.ciso_priority, ssphp.assessment.description, ssphp.score.color, ssphp.resource.id, ssphp.resource.tenant, ssphp.resource.subscription, ssphp.resource.subscription_name, ssphp.resource.resource_group, SSPHP_UID
          </query>
          <done>
            <set token="tkn_service_name">$result.ssphp.service.name$</set>
            <set token="tkn_current_service">$result.ssphp.service.name$</set>
          </done>
        </search>
        <option name="count">1</option>
      </table>
    </panel>
  </row>
  
  




<!-- ######################################################################################################################################### -->
<!-- ############################################################################ INPUTS ##################################################### -->
<!-- ######################################################################################################################################### -->
  
  
  <row>
    <panel id="menu1">
      <html>
        <style>
          #menu1{
            width:7% !important;
          }
        </style>
      </html>
      
      <input type="link" token="tokHide" searchWhenChanged="true" depends="$tokShowAll$">
        <label></label>
        <choice value="hide">Hide Menu</choice>
        <change>
          <condition value="hide">
            <set token="tokHideAll">true</set>
            <unset token="tokShowAll"></unset>
            <unset token="form.tokShow"></unset>
            <unset token="tokShow"></unset>
          </condition>
        </change>
      </input>
      
      <input type="link" token="tokShow" searchWhenChanged="true" depends="$tokHideAll$">
        <label></label>
        <choice value="show">Show Menu</choice>
        <change>
          <condition value="show">
            <set token="tokShowAll">true</set>
            <unset token="tokHideAll"></unset>
            <unset token="form.tokHide"></unset>
            <unset token="tokHide"></unset>

            <set token="tkn_dashboard_start">2</set>
          </condition>
        </change>
      </input>
    </panel>    
    
    
    <panel id="menu2" depends="$tokShowAll$">
      <html>
        <style>
          #menu2{
            width:70% !important;
          }
        </style>
      </html>
      
      <input type="dropdown" token="tkn_portfolio" searchWhenChanged="true">
        <label>Portfolio</label>
        <fieldForLabel>portfolio</fieldForLabel>
        <fieldForValue>portfolio</fieldForValue>
        <search base="base_menu">
          <query>
  | fields portfolio
  | dedup portfolio
  | sort 0 portfolio
          </query>
        </search>
        <change>
          <condition match=" like($tkn_dashboard_start$,&quot;2&quot;) ">
            <unset token="form.tkn_service_line"></unset>
            <unset token="form.tkn_product"></unset>
            <set token="tkn_resource_count">0</set>
          </condition>
          <condition>
            <set token="tkn_resource_count">0</set>
          </condition>
        </change>
      </input>
  
  
      <input type="dropdown" token="tkn_service_line" searchWhenChanged="true">
        <label>Service Line</label>
        <fieldForLabel>service_line</fieldForLabel>
        <fieldForValue>service_line</fieldForValue>
        <search base="base_menu">
          <query>
  | search portfolio=$tkn_portfolio|s$
  | fields service_line
  | dedup service_line
  | sort 0 service_line
          </query>
        </search>
        <change>
          <condition match=" like($tkn_dashboard_start$,&quot;2&quot;) ">
            <unset token="form.tkn_product"></unset>
            <set token="tkn_resource_count">0</set>
          </condition>
          <condition>
            <set token="tkn_resource_count">0</set>
          </condition>
        </change>
      </input>
  
  
      <input type="dropdown" token="tkn_product" searchWhenChanged="true">
        <label>Product</label>
        <fieldForLabel>product</fieldForLabel>
        <fieldForValue>product</fieldForValue>
        <search base="base_menu">
          <query>
  | search portfolio=$tkn_portfolio|s$ AND service_line=$tkn_service_line|s$
  | fields product
  | dedup product
  | sort 0 product
          </query>
        </search>
        <change>
          <condition match=" like($tkn_dashboard_start$,&quot;2&quot;) ">
          <set token="tkn_resource_count">0</set>
          </condition>
          <condition>
            <set token="tkn_resource_count">0</set>
          </condition>
        </change>
      </input>
    </panel>
    

<!-- ############################################################################ SERVICE DETAILS LINE ############################################## -->    
    <panel id="menu3" depends="$tokHideAll$">
      <html>
        <style>
          #menu3{
            width:70% !important;
          }
        </style>

        <head>
          <style>
            th, td {
              padding: 5px;
            }
            th {
              text-align: left;
            }
          </style>
        </head>
        <body>
          <table style="width:100%">
            <tr>
              <th style="width:30%">PORTFOLIO</th>
              <th style="width:40%">SERVICE LINE</th>
              <th style="width:30%">PRODUCT</th>
            </tr>
            <tr>
              <td style="font-size:175%;color:$tkn_colour_orange$;">$tkn_portfolio$</td>
              <td style="font-size:175%;color:$tkn_colour_orange$;">$tkn_service_line$</td>
              <td style="font-size:175%;color:$tkn_colour_orange$;">$tkn_product$</td>
            </tr>
          </table>
        </body>
      </html>
    </panel>
    
    
    <panel id="menu4" depends="$tokShowAll$">
      <html>
        <style>
          #menu4{
            width:23% !important;
          }
        </style>
      </html>
      
      <input type="radio" token="tkn_view" searchWhenChanged="true">
        <label>View</label>
        <choice value="a">Absolute</choice>
        <choice value="p">Percentage</choice>
        <default>a</default>
        <initialValue>a</initialValue>
        <change>
          <condition value="a">
            <set token="tkn_show_abs">true</set>
            <unset token="tkn_show_perc"></unset>
          </condition>
          <condition value="p">
            <unset token="tkn_show_abs"></unset>
            <set token="tkn_show_perc">true</set>
            
            
            <set token="tkn_dashboard_start">2</set> 
          </condition>
        </change>
      </input>
    </panel>
      
    <panel id="menu5" depends="$tokHideAll$">
      <html>
        <style>
          #menu5{
            width:23% !important;
          }
        </style>
      </html>
      
      <table>
        <search base="base_menu">
          <query>
            
| where portfolio=$tkn_portfolio|s$ AND service_line=$tkn_service_line|s$ AND product=$tkn_product|s$

| lookup ssphp_cost_centre_owner_emals.csv cost_centre_owner OUTPUT email as cost_centre_owner_email

| append 
    [| search index="ssphp_asset_inventory{{environment}}" 
    (ssphp.resource.source="AZURE" OR ssphp.resource.source="GITHUB") AND (ssphp.service.portfolio=$tkn_portfolio|s$ AND ssphp.service.service_line=$tkn_service_line|s$ AND ssphp.service.product=$tkn_product|s$)
    earliest=-2d@d latest=now

         [| inputlookup ssphp_last_asset_inventory_ssphp_run{{environment}}.csv where (inventory_type="azure" OR inventory_type="github")
          | stats max(SSPHP_RUN) as SSPHP_RUN by inventory_type
          | eval st="(ssphp.resource.source=\"".upper('inventory_type')."\" AND SSPHP_RUN=\"".'SSPHP_RUN'."\")"
          | stats values(st) as st
          | eval st="(".mvjoin('st'," OR ").")"
          | return $st]
     
| stats dc(ssphp.resource.id) as resources by ssphp.resource.source
    | eval total_{ssphp.resource.source}_resources='resources'
    | fields - resources, ssphp.resource.source]

| stats values(total_AZURE_resources) as total_azure_resources,
        values(total_GITHUB_resources) as total_github_resources,
        values(cost_centre_title) as cost_centre_title,
        values(cost_centre_owner) as cost_centre_owner, 
        values(cost_centre_owner_email) as cost_centre_owner_email, 
        values(financial_business_partner_email) as financial_business_partner_email, 
        values(hosting_provider_email) as hosting_provider_email, 
        values(hosting_support_email) as hosting_support_email, 
        values(product_owner_email) as product_owner_email

| eval service_details="Cost Cente : ".'cost_centre_title',
       service_details=if(isnotnull('cost_centre_owner') AND cost_centre_owner!="null", mvappend('service_details',"Cost Centre Owner : ".'cost_centre_owner'), 'service_details'),
       service_details=if(isnotnull('cost_centre_owner_email') AND cost_centre_owner!="null", mvappend('service_details',"Cost Centre Owner EMail : ".'cost_centre_owner_email'), 'service_details'),
       service_details=if(isnotnull('financial_business_partner_email') AND financial_business_partner_email!="null", mvappend('service_details',"Financial Business Partner EMail : ".'financial_business_partner_email'), 'service_details'),
       service_details=if(isnotnull('hosting_provider_email') AND hosting_provider_email!="null", mvappend('service_details',"Hosting Provider EMail : ".'hosting_provider_email'), 'service_details'),
       service_details=if(isnotnull('hosting_support_email') AND hosting_support_email!="null", mvappend('service_details',"Hosting Support EMail : ".'hosting_support_email'), 'service_details'),
       service_details=if(isnotnull('product_owner_email') AND product_owner_email!="null", mvappend('service_details',"Product Owner EMail : ".'product_owner_email'), 'service_details'),
       service_details=if(isnotnull('total_azure_resources') AND total_azure_resources!="null", mvappend('service_details',"Total Azure Resources : ".'total_azure_resources'), 'service_details'),
       service_details=if(isnotnull('total_github_resources') AND total_github_resources!="null", mvappend('service_details',"Total GitHub Resources : ".'total_github_resources'), 'service_details'),
       service_details=mvjoin('service_details',"
")
| table service_details
| rename service_details as "Service Details"
          </query>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
    
  </row>


<!-- #  <row rejects="$tkn_ready$">
    <panel>
      <html>
        <div id="div_header" style="background:darkgrey;color:white;font-weight:bold;font-size:$tkn_font_size_2$%;text-align:center;padding:$tkn_padding_2$">Requesting Data - Please Wait</div> 
      </html>
    </panel>
  </row># -->


  

<!-- ###################################################################################################################################### -->
<!-- ###################################################### SET TOKENS #################################################################### -->
<!-- ###################################################################################################################################### -->


  <row depends="$debug$">
    <panel>
      <table>
        <search>
          <query>
  | makeresults
  | eval app=$env:app|s$
  | table app
          </query>
          <done>
            <set token="tkn_current_app">$result.app$</set>
          </done>
        </search>
      </table>
    </panel>

    
    <panel>
      <table>
        <search>
          <query>
  | makeresults

  `ssphp_metrics_eval_field_colors{{environment}}`

  | table tkn_*
          </query>
          <done>
            <set token="tkn_colour_splunk_grey">$result.tkn_colour_splunk_grey$</set>
            <set token="tkn_colour_red">$result.tkn_colour_red$</set>
            <set token="tkn_colour_orange">$result.tkn_colour_orange$</set>
            <set token="tkn_colour_green">$result.tkn_colour_green$</set>
            <set token="tkn_colour_blue">$result.tkn_colour_blue$</set>
          </done>
        </search>
      </table>
    </panel>
  </row>
  
  
  <row depends="$debug$">
    <panel>
      <table>
        <search>
          <query>
  | makeresults
  | eval user_dashboard_token="&gt;&gt;&gt;&gt;".$tkn_portfolio|s$."::".$tkn_service_line|s$."::".$tkn_product|s$."::".$tkn__current_user_name|s$."::".$tkn__current_application|s$."&lt;&lt;&lt;&lt;"
  | table user_dashboard_token
          </query>
          <done>
            <set token="tkn_user_dashboard_token">$result.user_dashboard_token$</set>
          </done>
        </search>
      </table>
    </panel>
    

    <panel>
      <table>
        <search>
          <query>
index=_audit user=$tkn__current_user_name|s$ action=search "makeresults" "user_dashboard_token" provenance="UI:Dashboard:ip_sandbox" NOT ("index=_internal" OR "index=_audit") earliest=-30d latest=now
| rex field=_raw "^[\s\S]*\"\&gt;\&gt;\&gt;\&gt;\"\.\"(?&lt;portfolio&gt;[^\"]*)\"\.\"::\"\.\"(?&lt;service_line&gt;[^\"]*)\"\.\"::\"\.\"(?&lt;product&gt;[^\"]*)\"\.\"::\"\.\"(?&lt;user&gt;[^\"]*)\"\.\"::\"\.\"(?&lt;app&gt;[^\"]*)[\s\S]*$"
| eval previous_dashboard_token="&gt;&gt;&gt;&gt;".'portfolio'."::".'service_line'."::".'product'."::".'user'."::".'app'."&lt;&lt;&lt;&lt;",
       time=strftime(_time,"%Y-%m-%d %H:%M:%S")
| fields _time, time, previous_dashboard_token, portfolio, service_line, product```, user, app```
| sort 0 - _time
| dedup previous_dashboard_token

```| table time, previous_dashboard_token
| head 10
| stats values(previous_dashboard_token) as previous_dashboard_token```

| table previous_dashboard_token, portfolio, service_line, product
| head 1
          </query>
          <done> 
            <set token="form.tkn_portfolio">$result.portfolio$</set>
            <set token="form.tkn_service_line">$result.service_line$</set>
            <set token="form.tkn_product">$result.product$</set>
          </done>
        </search>
      </table>
    </panel>    
  </row>

  


<!-- ######################################################################################################################################### -->
<!-- ###################################################### TOP TOP SCORE ROW ################################################################ -->
<!-- ######################################################################################################################################### -->


<!-- ###################################################### CONFIG #################################################################### -->
  <row depends="$tkn_ready$,$debug$">
    <panel>
      <table>
        <search base="bs_1">
          <query>
| search (ssphp.use_case.category="POSTURE" OR ssphp.use_case.category="REPOS") AND ssphp.resource.id="***" 

| eval is_bad=if('ssphp.score.ciso_priority'="DfE Mandated" AND mvindex(split('ssphp.score.score',"|"),0)!="100",1,0)
| stats count, sum(is_bad) as is_bad by ssphp.resource.id
| eval is_bad=if('is_bad'>0,1,0)
| stats sum(is_bad) as total_resources_with_config_issues
            </query>
          <done>
            <eval token="tkn_config_number_total_resources">if(isnotnull($result.total_resources_with_config_issues$),$result.total_resources_with_config_issues$,"-")</eval>
          </done>
        </search>
      </table>
    </panel>



<!-- ###################################################### ALERTS #################################################################### -->

    <panel>
      <table>
        <search base="bs_1">
          <query>
| search (ssphp.use_case.category="VULNERABILITY" OR ssphp.use_case.category="CODE_SCAN") AND ssphp.resource.id="***" 

| eval is_bad=if('ssphp.score.ciso_priority'="DfE Mandated" AND mvindex(split('ssphp.score.score',"|"),0)!="100",1,0)
| stats count, sum(is_bad) as is_bad by ssphp.resource.id
| eval is_bad=if('is_bad'>0,1,0)
| stats sum(is_bad) as total_resources_with_alerts
            </query>
          <done>
            <eval token="tkn_alerts_number_total_resources">if(isnotnull($result.total_resources_with_alerts$),$result.total_resources_with_alerts$,"-")</eval>
          </done>
        </search>
      </table>
    </panel>
  </row>



  <row depends="$tkn_ready$">
    <panel>
      <html>
        <div id="div_header" style="background:darkslategrey;color:white;font-weight:bold;font-size:$tkn_font_size_2$%;text-align:center;padding:$tkn_padding_2$">$tkn_config_number_total_resources$</div> 
        <div id="div_header" style="background:darkslategrey;color:white;font-size:80%;text-align:center">Non-Compliant Resources</div>
        <div id="div_header" style="background:darkslategrey;color:yellow;font-size:100%;text-align:center">CONFIGURATION</div> 

      </html>
    </panel>

    <panel>
      <html>
        <div id="div_header" style="background:darkslategrey;color:white;font-weight:bold;font-size:$tkn_font_size_2$%;text-align:center;padding:$tkn_padding_2$">$tkn_alerts_number_total_resources$</div> 
        <div id="div_header" style="background:darkslategrey;color:white;font-size:80%;text-align:center">Non-Compliant Resources</div>
        <div id="div_header" style="background:darkslategrey;color:yellow;font-size:100%;text-align:center">ALERTS</div> 
      </html>
    </panel>
  </row>



<!-- ######################################################################################################################################### -->
<!-- ###################################################### TOP SCORE ROW #################################################################### -->
<!-- ######################################################################################################################################### -->


<!-- ###################################################### POSTURE #################################################################### -->
  <row depends="$tkn_ready$,$debug$">
    <panel>
      <table>
        <search base="bs_1">
          <query>
| search ssphp.use_case.category="POSTURE" AND ssphp.resource.id="***" 

| eval rg=coalesce('ssphp.resource.tenant'."/".'ssphp.resource.subscription'."/".'ssphp.resource.resource_group',"-")

| stats count, sum(eval(if('ssphp.score.ciso_priority'="DfE Mandated" AND mvindex(split('ssphp.score.score',"|"),0)!="100",1,0))) as rg_bad by rg
| stats count as rg_total, sum(eval(if('rg_bad'>0,1,0))) as rg_bad

| eval rg_good='rg_total'-'rg_bad'

| eval number_total_resources='rg_total',
       number_passed_resources='rg_good',
       perc_passed_resources=floor(('number_passed_resources'*100)/'number_total_resources')." %",
       abs='number_passed_resources'." / ".'number_total_resources',
       color=case(isnull('perc_passed_resources') OR 'perc_passed_resources'="","#171D21",
                                  'perc_passed_resources'=100,"#6AB187",
                                  1==1,"#D32D41"),  
       abs=if(isnull('abs'),"-",'abs')

| table number_total_resources, number_passed_resources, perc_passed_resources, abs, color
            </query>
          <done>
            <set token="tkn_posture_number_total_resources">$result.number_total_resources$</set>
            <set token="tkn_posture_number_passed_resources">$result.number_passed_resources$</set>
            <set token="tkn_posture_perc_passed_resources">$result.perc_passed_resources$</set>
            <set token="tkn_posture_abs">$result.abs$</set>
            <set token="tkn_posture_color">$result.color$</set>
          </done>
        </search>
      </table>
    </panel>
  </row>



<!-- ###################################################### VULNERABILITY #################################################################### -->
  <row depends="$tkn_ready$,$debug$">
    <panel>
      <table>
        <search base="bs_1">
          <query>
| search ssphp.use_case.category="VULNERABILITY" AND ssphp.resource.id="***" AND ssphp.resource.id="*/virtualmachines/*"

| stats count, sum(eval(if('ssphp.score.ciso_priority'="DfE Mandated" AND mvindex(split('ssphp.score.score',"|"),0)!="100",1,0))) as rid_bad by ssphp.resource.id
| stats count as rid_total, sum(eval(if('rid_bad'>0,1,0))) as rid_bad

| eval rid_good='rid_total'-'rid_bad'

| eval number_total_resources='rid_total',
       number_passed_resources='rid_good',
       perc_passed_resources=floor(('number_passed_resources'*100)/'number_total_resources')." %",
       abs='number_passed_resources'." / ".'number_total_resources',
       color=case(isnull('perc_passed_resources') OR 'perc_passed_resources'="","#171D21",
                                  'perc_passed_resources'=100,"#6AB187",
                                  1==1,"#D32D41"),  
       abs=if(isnull('abs'),"-",'abs')

| table number_total_resources, number_passed_resources, perc_passed_resources, abs, color
            </query>
          <done>
            <set token="tkn_vulnerability_number_total_resources">$result.number_total_resources$</set>
            <set token="tkn_vulnerability_number_passed_resources">$result.number_passed_resources$</set>
            <set token="tkn_vulnerability_perc_passed_resources">$result.perc_passed_resources$</set>
            <set token="tkn_vulnerability_abs">$result.abs$</set>
            <set token="tkn_vulnerability_color">$result.color$</set>
          </done>
        </search>
      </table>
    </panel>
  </row>



<!-- ###################################################### REPOS #################################################################### -->
  <row depends="$tkn_ready$,$debug$">
    <panel>
      <table>
        <search base="bs_1">
          <query>
| search ssphp.use_case.category="REPOS" AND ssphp.resource.id="***"

| stats count, sum(eval(if('ssphp.score.ciso_priority'="DfE Mandated" AND mvindex(split('ssphp.score.score',"|"),0)!="100",1,0))) as rid_bad by ssphp.resource.id
| stats count as rid_total, sum(eval(if('rid_bad'>0,1,0))) as rid_bad

| eval rid_good='rid_total'-'rid_bad'

| eval number_total_resources='rid_total',
       number_passed_resources='rid_good',
       perc_passed_resources=floor(('number_passed_resources'*100)/'number_total_resources')." %",
       abs='number_passed_resources'." / ".'number_total_resources',
       color=case(isnull('perc_passed_resources') OR 'perc_passed_resources'="","#171D21",
                                  'perc_passed_resources'=100,"#6AB187",
                                  1==1,"#D32D41"),  
       abs=if(isnull('abs'),"-",'abs')

| table number_total_resources, number_passed_resources, perc_passed_resources, abs, color
            </query>
          <done>
            <set token="tkn_repos_number_total_resources">$result.number_total_resources$</set>
            <set token="tkn_repos_number_passed_resources">$result.number_passed_resources$</set>
            <set token="tkn_repos_perc_passed_resources">$result.perc_passed_resources$</set>
            <set token="tkn_repos_abs">$result.abs$</set>
            <set token="tkn_repos_color">$result.color$</set>
          </done>
        </search>
      </table>
    </panel>
  </row>



<!-- ###################################################### CODE_SCAN #################################################################### -->
  <row depends="$tkn_ready$,$debug$">
    <panel>
      <table>
        <search base="bs_1">
          <query>
| search ssphp.use_case.category="CODE_SCAN" AND ssphp.resource.id="***"

| eval ssphp.resource.id=if(mvcount('ssphp.resource.id')>1,mvindex('ssphp.resource.id',0),'ssphp.resource.id')

| stats count, sum(eval(if('ssphp.score.ciso_priority'="DfE Mandated" AND mvindex(split('ssphp.score.score',"|"),0)!="100",1,0))) as rid_bad by ssphp.resource.id
| stats count as rid_total, sum(eval(if('rid_bad'>0,1,0))) as rid_bad

| eval rid_good='rid_total'-'rid_bad'

| eval number_total_resources='rid_total',
       number_passed_resources='rid_good',
       perc_passed_resources=floor(('number_passed_resources'*100)/'number_total_resources')." %",
       abs='number_passed_resources'." / ".'number_total_resources',
       color=case(isnull('perc_passed_resources') OR 'perc_passed_resources'="","#171D21",
                                  'perc_passed_resources'=100,"#6AB187",
                                  1==1,"#D32D41"),  
       abs=if(isnull('abs'),"-",'abs')

| table number_total_resources, number_passed_resources, perc_passed_resources, abs, color
            </query>
          <done>
            <set token="tkn_codescan_number_total_resources">$result.number_total_resources$</set>
            <set token="tkn_codescan_number_passed_resources">$result.number_passed_resources$</set>
            <set token="tkn_codescan_perc_passed_resources">$result.perc_passed_resources$</set>
            <set token="tkn_codescan_abs">$result.abs$</set>
            <set token="tkn_codescan_color">$result.color$</set>
          </done>
        </search>
      </table>
    </panel>
  </row>



  <row depends="$tkn_ready$">
    <panel depends="$tkn_ready$,$tkn_show_abs$">
      <html>
        <div id="div_header" style="background:$tkn_posture_color$;color:white;font-weight:bold;font-size:$tkn_font_size_2$%;text-align:center;padding:$tkn_padding_2$">$tkn_posture_abs$</div> 
        <div id="div_header" style="background:$tkn_posture_color$;color:white;font-size:80%;text-align:center">Compliant Resource Groups</div>
        <div id="div_header" style="background:$tkn_posture_color$;color:yellow;font-size:100%;text-align:center">POSTURE CONFIGURATION</div> 
      </html>
    </panel>
    <panel depends="$tkn_ready$,$tkn_show_perc$">
      <html>
        <div id="div_header" style="background:$tkn_posture_color$;color:white;font-weight:bold;font-size:$tkn_font_size_2$%;text-align:center;padding:$tkn_padding_2$">$tkn_posture_perc_passed_resources$</div> 
        <div id="div_header" style="background:$tkn_posture_color$;color:white;font-size:80%;text-align:center">Compliant Resource Groups</div>
        <div id="div_header" style="background:$tkn_posture_color$;color:yellow;font-size:100%;text-align:center">POSTURE CONFIGURATION</div> 
      </html>
    </panel>
    

    <panel depends="$tkn_ready$,$tkn_show_abs$">
      <html>
        <div id="div_header" style="background:$tkn_repos_color$;color:white;font-weight:bold;font-size:$tkn_font_size_2$%;text-align:center;padding:$tkn_padding_2$">$tkn_repos_abs$</div> 
        <div id="div_header" style="background:$tkn_repos_color$;color:white;font-size:80%;text-align:center">GitHub Repos Compliant with CIS Benchmarks</div>
        <div id="div_header" style="background:$tkn_repos_color$;color:yellow;font-size:100%;text-align:center">REPOSITORY CONFIGURATION</div> 
      </html>
    </panel>
    <panel depends="$tkn_ready$,$tkn_show_perc$">
      <html>
        <div id="div_header" style="background:$tkn_repos_color$;color:white;font-weight:bold;font-size:$tkn_font_size_2$%;text-align:center;padding:$tkn_padding_2$">$tkn_repos_perc_passed_resources$</div> 
        <div id="div_header" style="background:$tkn_repos_color$;color:white;font-size:80%;text-align:center">GitHub Repos Compliant with CIS Benchmarks</div>
        <div id="div_header" style="background:$tkn_repos_color$;color:yellow;font-size:100%;text-align:center">REPOSITORY CONFIGURATION</div> 
      </html>
    </panel>
    

    <panel depends="$tkn_ready$,$tkn_show_abs$">
      <html>
        <div id="div_header" style="background:$tkn_codescan_color$;color:white;font-weight:bold;font-size:$tkn_font_size_2$%;text-align:center;padding:$tkn_padding_2$">$tkn_codescan_abs$</div> 
        <div id="div_header" style="background:$tkn_codescan_color$;color:white;font-size:80%;text-align:center">Compliant GitHub Repos</div>
        <div id="div_header" style="background:$tkn_codescan_color$;color:yellow;font-size:100%;text-align:center">CODE SCANNING ALERTS</div> 
      </html>
    </panel>
    <panel depends="$tkn_ready$,$tkn_show_perc$">
      <html>
        <div id="div_header" style="background:$tkn_codescan_color$;color:white;font-weight:bold;font-size:$tkn_font_size_2$%;text-align:center;padding:$tkn_padding_2$">$tkn_codescan_perc_passed_resources$</div> 
        <div id="div_header" style="background:$tkn_codescan_color$;color:white;font-size:80%;text-align:center">Compliant GitHub Repos</div>
        <div id="div_header" style="background:$tkn_codescan_color$;color:yellow;font-size:100%;text-align:center">CODE SCANNING ALERTS</div> 
      </html>
    </panel>
    

    <panel depends="$tkn_ready$,$tkn_show_abs$">
      <html>
        <div id="div_header" style="background:$tkn_vulnerability_color$;color:white;font-weight:bold;font-size:$tkn_font_size_2$%;text-align:center;padding:$tkn_padding_2$">$tkn_vulnerability_abs$</div> 
        <div id="div_header" style="background:$tkn_vulnerability_color$;color:white;font-size:80%;text-align:center">Compliant Virtual Machines</div>
        <div id="div_header" style="background:$tkn_vulnerability_color$;color:yellow;font-size:100%;text-align:center">VM VULNERABILITY ALERTS</div> 
      </html>
    </panel>
    <panel depends="$tkn_ready$,$tkn_show_perc$">
      <html>
        <div id="div_header" style="background:$tkn_vulnerability_color$;color:white;font-weight:bold;font-size:$tkn_font_size_2$%;text-align:center;padding:$tkn_padding_2$">$tkn_vulnerability_perc_passed_resources$</div> 
        <div id="div_header" style="background:$tkn_vulnerability_color$;color:white;font-size:80%;text-align:center">Compliant Virtual Machines</div>
        <div id="div_header" style="background:$tkn_vulnerability_color$;color:yellow;font-size:100%;text-align:center">VM VULNERABILITY ALERTS</div> 
      </html>
    </panel>
  </row>


<!-- #################################################################################################################################### --> 
<!-- ################################################# Main Data Table Filters ########################################################## --> 
<!-- #################################################################################################################################### --> 


  <row>

      
    <panel id="m1">
      <html>
        <style>
          #m1{
            width:100% !important;
          }
        </style>
      </html>
    
      <input type="checkbox" token="tkn_fields" searchWhenChanged="true">
        <label>View</label>
        <choice value="N">Non-Compliant only</choice>
        <choice value="C">DfE Mandated only</choice>
        <change>
          <eval token="tkn_fields">if(isnull($tkn_fields$), &quot; &quot;, $tkn_fields$)</eval>
        </change>
      </input>

      <input type="radio" token="tkn_group_by" searchWhenChanged="true">
        <label>Show</label>
        <choice value="L">Control Details</choice>
        <choice value="R">Controls by Resource</choice> 
        <choice value="C">Resources by Control</choice>
        <choice value="S">Service Resource List</choice>
        <default>L</default>
        <initialValue>L</initialValue>
        <change>
          <condition value="L">
            <set token="tkn_show_by_list">true</set>
            <unset token="tkn_show_by_resource"></unset>
            <unset token="tkn_show_by_control"></unset>
            <unset token="tkn_show_by_service"></unset>
          </condition>
          <condition value="R">
            <set token="tkn_show_by_resource">true</set>
            <unset token="tkn_show_by_list"></unset>
            <unset token="tkn_show_by_control"></unset>
            <unset token="tkn_show_by_service"></unset>
          </condition>
          <condition value="C">
            <set token="tkn_show_by_control">true</set>
            <unset token="tkn_show_by_list"></unset>
            <unset token="tkn_show_by_resource"></unset>
            <unset token="tkn_show_by_service"></unset>
          </condition>
          <condition value="S">
            <set token="tkn_show_by_service">true</set>
            <unset token="tkn_show_by_control"></unset>
            <unset token="tkn_show_by_list"></unset>
            <unset token="tkn_show_by_resource"></unset>
          </condition>
        </change>
      </input>

      <input type="multiselect" token="tkn_category" searchWhenChanged="true">
        <label>Include Controls</label>
        <choice value="POSTURE">Posture</choice>
        <choice value="VULNERABILITY">Vulnerabilities</choice>
        <choice value="REPOS">Repos</choice>
        <choice value="CODE_SCAN">Code Scanning</choice>
        <default>POSTURE,VULNERABILITY,REPOS,CODE_SCAN</default>
        <initialValue>POSTURE,VULNERABILITY,REPOS,CODE_SCAN</initialValue>
        <delimiter> OR </delimiter>
        <prefix>| search (</prefix>
        <suffix>)</suffix>
        <valuePrefix>ssphp.use_case.category="</valuePrefix>
        <valueSuffix>"</valueSuffix>
      </input>


      <input type="multiselect" token="tkn_code_tools">
        <label>Code Scanning Tools</label>
        <choice value="*">ALL</choice>
        <default>*</default>
        <initialValue>*</initialValue>
        <prefix>| search ssphp.use_case.category!="CODE_SCAN" OR (ssphp.use_case.category="CODE_SCAN" AND (</prefix>
        <suffix>)) </suffix>
        <valuePrefix>ssphp.assessment.source="</valuePrefix>
        <valueSuffix>"</valueSuffix>
        <delimiter> OR </delimiter>
        <fieldForLabel>tools</fieldForLabel>
        <fieldForValue>tools</fieldForValue>
        <search>
          <query>
`ssphp_summary_index{{environment}}` earliest=-2d@d latest=now ssphp.use_case.category="CODE_SCAN"

| search NOT ssphp.assessment.sub_source="true"

| fields ssphp.assessment.source
| dedup ssphp.assessment.source
| eval tools=case('ssphp.assessment.source'="DEPENDABOT","Dependabot",
                  'ssphp.assessment.source'="NO TOOL","No Tool",
                  1==1,'ssphp.assessment.source')
| table tools
| sort tools
          </query>
          <earliest>-2d@d</earliest>
          <latest>now</latest>
        </search>
      </input>

      <input type="text" token="tkn_resource_search" searchWhenChanged="true">
        <label>Search for Resource</label>
        <prefix>"*</prefix>
        <suffix>*" </suffix>
        <default>*</default>
        <initialValue>*</initialValue>
      </input>
    </panel>    
    


<!-- NOT PART OF P1 DELIVERABLE    
    <panel id="m4">
      <html>
        <style>
          #m4{
            width:12% !important;
          }
        </style>

<div><span><a href="ssphp_dfe_service_threat_model?tkn__service=$tkn__service$" class="btn btn-primary" style="color:white;background-color:lightgrey;text-align:left;display:block;width:100%;" target="_blank">Service Threat Model Dashboard</a></span></div>
      </html>
    </panel>
 --> 
 
<!-- Search to build filter text --> 
    <panel depends="$debug$">
      <table>
        <search>
          <query>
| makeresults
| eval txt1="| where match('ssphp.score.compliance_status',\"^Non-Compliant.*\")",
       txt2="| where 'ssphp.score.ciso_priority'=\"DfE Mandated\"",
       infield=$tkn_fields|s$,
       
       C=if(like(infield,"%C%"),'txt2'," "),
       N=if(like(infield,"%N%"),'txt1'," "),
       search='C'.'N'

| table txt1, txt2, search, C, N, infield
          </query>
          <done>
            <set token="tkn_search_filter">$result.search$</set>
          </done>
        </search>
      </table>
    </panel>
  </row>


<!-- #################################################################################################################################### --> 
<!-- ############################################# Main Data Table === SHOW BY LIST ##################################################### --> 
<!-- #################################################################################################################################### --> 

  <row depends="$debug$, $tkn_show_by_list$">
    <html>
      <style>
         .css_for_green{ 
         background-color: $tkn_colour_green$ !important;
         color:#000000 !important;
         font-size: 100% !important;
         }
         .css_for_orange{ 
         background-color: $tkn_colour_orange$ !important;
         color:#000000 !important;
         font-size: 100% !important;
         }
         .css_for_red{
         background-color: $tkn_colour_red$ !important;
         color:#000000 !important;
         font-size: 100% !important;
         }
         .css_for_blue{
         background-color: $tkn_colour_blue$ !important;
         font-size: 100% !important;
         }
      </style>
    </html>
    
    <html>
      <style>
        #table1 th:nth-child(1) {
          width: 200px;
        }
        #table1 th:nth-child(2) {
          width: 200px;
        }
        #table1 th:nth-child(3) {
          width: 50px;
        }
        #table1 th:nth-child(4) {
          width: 100px;
        }
        #table1 th:nth-child(5) {
          width: 50px;
        }
        #table1 th:nth-child(7) {
          width: 300px;
        }
      </style>
    </html>
  </row>



  <row depends="$tkn_show_by_list$">
    <panel>
      <html>
        <style>
          .green{
            color:green !important;
          }
          .blue{
            color:cyan !important;
          }
          .red{
            color:red !important;
          }
          .orange{
            color:orange !important;
          }
          .yellow{
            color:yellow !important;
          }
          .lightgrey{
            color:gray !important;
          }
          .lightblue{
            color:#485959 !important;
          }
        </style>
      </html>
      <html>
        <style>
           .css_for_green{ 
           background-color: $tkn_colour_green$ !important;
           color:#000000 !important;
           font-size: 100% !important;
           }
           .css_for_orange{ 
           background-color: $tkn_colour_orange$ !important;
           color:#000000 !important;
           font-size: 100% !important;
           }
           .css_for_red{
           background-color: $tkn_colour_red$ !important;
           color:#000000 !important;
           font-size: 100% !important;
           }
           .css_for_blue{
           background-color: $tkn_colour_blue$ !important;
           font-size: 100% !important;
           }
        </style>
      </html>
      <table id="table1">
        <title>Control Details &amp; Scores [$tkn_controls_total_list$]</title>
        <search base="bs_1">
          <query>
$tkn_category$

$tkn_code_tools$

| search ssphp.resource.id=$tkn_resource_search$ AND ssphp.resource.id!=""

$tkn_search_filter$

``` sort the lines properly ```
| fillnull value=0 n3
| eval n4=case('ssphp.score.ciso_priority'="DfE Mandated",1,'ssphp.score.ciso_priority'="Recommended",2,'ssphp.score.ciso_priority'="Desirable",3,1==1,4),
        n5=case(match('ssphp.score.compliance_status',"^Non-Compliant.*"),1,match('ssphp.score.compliance_status',"^Compliant.*"),2,1==1,3),
        sort_field='n4'.'n5'
| sort 0 sort_field, ssphp.use_case.id

| table ssphp.service.portfolio, ssphp.service.service_line, ssphp.service.product, ssphp.use_case.id, ssphp.use_case.title, ssphp.assessment.display_name, ssphp.score.score, ssphp.score.compliance_status, ssphp.score.ciso_priority, ssphp.assessment.description, ssphp.score.color, ssphp.resource.id, SSPHP_UID


| eval "DfE Service"='ssphp.service.id'
| rex field=ssphp.score.score "^^(?&lt;count_score&gt;[^|]*)|"

| rename ssphp.use_case.title as "Use Case",
         ssphp.assessment.display_name  as "Control Title", 
         ssphp.score.score as "Score",
         ssphp.score.compliance_status as "Compliance Status",
         ssphp.score.ciso_priority as "Control Type",
         ssphp.assessment.description as "Description",
         ssphp.resource.id as "Resource Details"

| eventstats count as number_controls_total
| eval number_controls_total_string=tostring('number_controls_total', "commas")
          </query>
          <done>
            <eval token="tkn_controls_total_list">if(isnotnull($result.number_controls_total_string$),$result.number_controls_total_string$,"0")</eval>
            <eval token="tkn_ready">if(isnotnull($result.number_controls_total$) AND $result.number_controls_total$!="" AND $result.number_controls_total$&gt;0,"true",null())</eval>
          </done>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <option name="drilldown">row</option>
        <fields>"Use Case","Control Title","Score","Compliance Status","Control Type","Description","Resource Details"</fields>
        <drilldown>
          <link target="_blank">/app/$tkn_current_app$/ssphp_service_detail?tkn__uid=$row.SSPHP_UID$</link>
        </drilldown>
      </table>
    </panel>
  </row>



  


<!-- #################################################################################################################################### --> 
<!-- ########################################## Main Data Table === SHOW BY RESOURCE #################################################### --> 
<!-- #################################################################################################################################### --> 


  <row depends="$tkn_show_by_resource$">
    <panel>
      <title>Controls by Resource [$tkn_controls_total_resources$]</title>
      <table>
        <search base="bs_1">
          <query>
$tkn_category$

$tkn_code_tools$

$tkn_search_filter$


| eval ssphp.assessment.display_name=if('ssphp.use_case.category'="CODE_SCAN" AND 'ssphp.assessment.source'="Dependabot",'ssphp.assessment.display_name'." (".mvindex('ssphp.resource.id',1).")",'ssphp.assessment.display_name'),
       ssphp.resource.id=if('ssphp.use_case.category'="CODE_SCAN" AND 'ssphp.assessment.source'="Dependabot",mvindex('ssphp.resource.id',0),'ssphp.resource.id')

| rename ssphp.use_case.title as "Use Case",
         ssphp.assessment.display_name  as "Control Title", 
         ssphp.score.score as "Score",
         ssphp.score.compliance_status as "Compliance Status",
         ssphp.score.ciso_priority as "Control Type",
         ssphp.assessment.description as "Description",
         ssphp.resource.id as "Resource Details"

| where isnotnull('Control Title') AND trim('Control Title')!=""
| eval display_control_title='ssphp.assessment.source'."::".'Control Title'." [".mvindex(split('Score',"|"),0)."]"


| stats values(display_control_title) as "Control Title" by "Resource Details"

| search "Resource Details"=$tkn_resource_search$ AND "Resource Details"!=""

| eventstats count as number_controls_total
| sort 0 "Resource Details"
          </query>
          <done>
            <eval token="tkn_controls_total_resources">if(isnotnull($result.number_controls_total$),$result.number_controls_total$,"0")</eval>
          </done>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <option name="drilldown">none</option>
        <fields>"Resource Details","Control Title"</fields>
      </table>
    </panel>
  </row>



  


<!-- #################################################################################################################################### --> 
<!-- ########################################## Main Data Table === SHOW BY CONTROL #################################################### --> 
<!-- #################################################################################################################################### --> 


  <row depends="$tkn_show_by_control$">
    <panel>
      <title>Resources by Control [$tkn_controls_total_controls$]</title>
      <table>
        <search base="bs_1">
          <query>
$tkn_category$

$tkn_code_tools$

$tkn_search_filter$

| rename ssphp.use_case.title as "Use Case",
         ssphp.assessment.display_name  as "Control Title", 
         ssphp.score.score as "Score",
         ssphp.score.compliance_status as "Compliance Status",
         ssphp.score.ciso_priority as "Control Type",
         ssphp.assessment.description as "Description",
         ssphp.resource.id as "Resource Details"

| where isnotnull('Control Title') AND trim('Control Title')!=""
| eval "Control Title"='ssphp.assessment.source'."::".'Control Title'

| search "Resource Details"=$tkn_resource_search$ AND "Resource Details"!=""
| stats values("Resource Details") as "Resource Details" by "Control Title"

| eventstats count as number_controls_total
| sort 0 "Resource Details"
          </query>
          <done>
            <eval token="tkn_controls_total_controls">if(isnotnull($result.number_controls_total$),$result.number_controls_total$,"0")</eval>
          </done>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <option name="drilldown">none</option>
        <fields>"Control Title","Resource Details"</fields>
      </table>
    </panel>
  </row>



  


<!-- #################################################################################################################################### --> 
<!-- ########################################## Main Data Table === SHOW BY SERVICE RESOURCE LIST ####################################### --> 
<!-- #################################################################################################################################### --> 


  <row depends="$tkn_show_by_service$">
    <panel id="list_azure_resource_table">
      <html>
        <style>
          #list_azure_resource_table{
            width:75% !important;
          }
          #table_azure_resource_table th:nth-child(4) {
            width: 100px;
        }
        </style>
      </html>
      <title>Azure Resources [$tkn_number_controls_service_azure$]</title>
      <table id="table_azure_resource_table">
        <search>
          <query>
index="ssphp_asset_inventory{{environment}}" 
    (ssphp.resource.source="AZURE") 
    earliest=-2d@d latest=now

    [| inputlookup ssphp_last_asset_inventory_ssphp_run{{environment}}.csv where inventory_type="azure"
     | stats max(SSPHP_RUN) as SSPHP_RUN
     | return SSPHP_RUN]

| search ssphp.service.portfolio=$tkn_portfolio|s$ AND ssphp.service.service_line=$tkn_service_line|s$ AND ssphp.service.product=$tkn_product|s$

| stats values(ssphp.resource.id) as "Resource ID"
        by ssphp.resource.tenant, ssphp.resource.subscription_name, ssphp.resource.resource_group, ssphp.resource.type

| rename ssphp.resource.tenant as Tenant, 
         ssphp.resource.subscription_name as Subscription, 
         ssphp.resource.resource_group as "Resource Group",
         ssphp.resource.type as "Resource Type"

| sort 0 Tenant, Subscription, "Resource Group", "Resource Type", "Resource ID"

| eventstats count as number_controls_service_azure
          </query>
          <done>
            <eval token="tkn_number_controls_service_azure">if(isnotnull($result.number_controls_service_azure$),$result.number_controls_service_azure$,"0")</eval>
          </done>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <option name="drilldown">none</option>
        <fields>Tenant, Subscription, "Resource Group", "Resource Type", "Resource ID"</fields>
      </table>
    </panel>
    


    <panel id="list_github_resource_table">
      <html>
        <style>
          #list_github_resource_table{
            width:25% !important;
          }
        </style>
      </html>
      <title>GitHub Repositories [$tkn_number_controls_service_github$]</title>
      <table>
        <search>
          <query>
index="ssphp_asset_inventory{{environment}}" 
    (ssphp.resource.source="GITHUB") 
    earliest=-2d@d latest=now

    [| inputlookup ssphp_last_asset_inventory_ssphp_run{{environment}}.csv where inventory_type="github"
     | stats max(SSPHP_RUN) as SSPHP_RUN
     | return SSPHP_RUN]

| search ssphp.service.portfolio=$tkn_portfolio|s$ AND ssphp.service.service_line=$tkn_service_line|s$ AND ssphp.service.product=$tkn_product|s$

| eventstats count as number_controls_service_github

| eval Organisation=mvindex(split('ssphp.resource.full_name',"/"),0)
| stats values(number_controls_service_github) as number_controls_service_github,
        values(ssphp.resource.name) as "Repo Name" 
        by Organisation

          </query>
          <done>
            <eval token="tkn_number_controls_service_github">if(isnotnull($result.number_controls_service_github$),$result.number_controls_service_github$,"0")</eval>
          </done>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <option name="drilldown">none</option>
        <fields>Organisation, "Repo Name"</fields>
      </table>
    </panel>
  </row>





<!-- #################################################################################################################################### --> 
<!-- ###################################################### FOOTER ROW ################################################################## -->
<!-- #################################################################################################################################### --> 

<row depends="$debug$">
    <panel>
        <table>
            <search>
                <query>
| rest /services/authentication/current-context splunk_server=local 
| table username, roles
| eval roles=case(username="ian.pearl@education.gov.uk",mvappend('roles',"dfe_ssphp_service_user_s194"),
                    username="alex.kinnane@education.gov.uk",mvappend('roles',"dfe_ssphp_service_user_s194"),
                    username="sam.pritchard@education.gov.uk",mvappend('roles',"dfe_ssphp_service_user_s194"),
                    1==1,'roles')
| eval roles=mvfilter(match('roles',"dfe_ssphp_service_user_s\d{3}"))
| where isnotnull('roles')
| rex field=roles "dfe_ssphp_service_user_(?&lt;service&gt;s\d{3})$"
| eval app=$env:app|s$
| table username, service, app
                </query>
                <done>
                    <set token="tkn__current_user_name">$result.username$</set>
                    <set token="tkn__current_user_service">$result.service$</set>
                    <set token="tkn__current_application">$result.app$</set>
                </done>
            </search>
        </table>
    </panel>

    <panel>
        <html>Current User : $tkn__current_user_name$&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Current App : $tkn__current_application$&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;User Service : $tkn__current_user_service$&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Version : 5d9adba8cb2408f9193f00c611ddf74a974241ae</html>
    </panel>
</row>


</dashboard>