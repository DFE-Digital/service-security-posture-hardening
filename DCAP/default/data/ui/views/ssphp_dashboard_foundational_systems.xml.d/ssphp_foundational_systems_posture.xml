{% if environment=="_DEV" %}
<dashboard version="1.1" theme="light" hideFilters="true" script="js/table_cell_color.js">
{% else %}
<dashboard version="1.1" theme="dark" hideFilters="true" script="js/table_cell_color.js">
{% endif %}  


  <label>Foundational Systems : Security Posture Compliance Dashboard</label>
  <description>{{environment}} v5.2.8</description>

  <init>
    <unset token="tkn_ready"></unset>
  </init>

  <fieldset submitButton="false">
    <input type="radio" token="tkn_view" searchWhenChanged="true">
      <label>View</label>
      <choice value="a">Absolute</choice>
      <choice value="p">Percentage</choice>
      <default>a</default>
      <initialValue>a</initialValue>
      <change>
        <condition value="a">
          <set token="tkn_show_abs">true</set>
          <unset token="tkn_show_perc"></unset>
        </condition>
        <condition value="p">
          <unset token="tkn_show_abs"></unset>
          <set token="tkn_show_perc">true</set>
        </condition>
      </change>
    </input>

<input type="radio" token="tkn_footer" searchWhenChanged="true">
    <label>Show Dashboard Details</label>
    <choice value="s">Show</choice>
    <choice value="h">Hide</choice>
    <default>h</default>
    <initialValue>h</initialValue>
    <change>
      <condition value="s">
        <set token="tkn_show_footer">true</set>
      </condition>
      <condition>
        <unset token="tkn_show_footer"></unset>
      </condition>
    </change>
  </input>
  

  </fieldset>



<!-- ################### Set Target Service and other Tokens ################### --> 

  <row depends="$never_show$">
    <panel>
      <table>
        <search>
          <query>
  | makeresults
  | eval app=$env:app|s$
  | table app
          </query>
          <done>
            <set token="tkn_current_app">$result.app$</set>
          </done>
        </search>
      </table>
    </panel>
    

    <panel>
      <table>
        <search>
          <query>
  | makeresults

  `ssphp_metrics_eval_field_colors{{environment}}`

  | table tkn_*
          </query>
          <done>
            <set token="tkn_colour_splunk_grey">$result.tkn_colour_splunk_grey$</set>
            <set token="tkn_colour_red">$result.tkn_colour_red$</set>
            <set token="tkn_colour_orange">$result.tkn_colour_orange$</set>
            <set token="tkn_colour_green">$result.tkn_colour_green$</set>
            <set token="tkn_colour_blue">$result.tkn_colour_blue$</set>
          </done>
        </search>
      </table>
    </panel>
  </row>



<!-- ################### STYLE ROW ################### -->   

  <row depends="$never_show$">
      <html>
        <style>
          .absolute {
            color: white !important;
            font-weight: bold !important;
            font-size: 800% !important;
            text-align: center !important;
            padding: 10 !important;
            line-height: 1.25 !important;
          }
          .undervalue {
            color: white !important;
            font-weight: bold !important;
            font-size: 150% !important;
            text-align: center !important;
            padding: 10 !important;
            line-height: 1.5 !important;
          }
          a:link {
            color: white;
            background-color: transparent;
            text-decoration: none;
          }
          a:visited {
            color: white;
            background-color: transparent;
            text-decoration: none;
          }
          a:hover {
            color: LightBlue;
            background-color: transparent;
            text-decoration: underline;
          }
          a:active {
            color: white;
            background-color: transparent;
            text-decoration: underline;
          }
        </style>
      </html>
  </row>



<!-- ############################################################################################################################################################# -->   
<!-- ################################################################### Foundational Services ################################################################### -->   
<!-- ############################################################################################################################################################# -->   


<!-- ################### Header Row - Foundational Services ##################

  <row>
    <html>
      <div id="div_header" style="color:yellow;font-weight:bold;font-size:125%;padding:10;">FOUNDATIONAL SERVICES : COMPLIANT CONTROLS
        <span><a href="ssphp_foundational_systems_dashboard_help?tkn_posture=true" class="btn btn-primary" style="color:black;background-color:grey;text-align:center;display:block;float:right;width:12%;" target="_blank">Dashboard Help</a></span></div> 
    </html>
  </row>
# --> 




<!-- ################### DISPLAY ROWS - Foundational Services ################### -->   


<!-- ######### AAD ROW ######### -->   
  <row depends="$tkn_ready$">

    <panel depends="$never_show$">
      <html>
        <style>
          #LeftPanel_abs_aad{
            width:70% !important;
          }
          #LeftPanel_perc_aad{
            width:70% !important;
          }
          #RightPanel_aad{
            width:30% !important;
          }
        </style>
      </html>
    </panel>

    <panel id="LeftPanel_abs_aad" depends="$tkn_show_abs$">
      <html>
        <div class="absolute" style="background:$tkn_AAD_color$;"><a href="ssphp_foundational_systems_service?form.tkn__service=aad" target="_blank">$tkn_AAD_score_abs$</a></div>
        <div class="undervalue" style="background:$tkn_AAD_color$;"><a href="ssphp_foundational_systems_service?form.tkn__service=aad" target="_blank">AAD Entra</a></div>
      </html>
    </panel>

    <panel id="LeftPanel_perc_aad" depends="$tkn_show_perc$">
      <html>
        <div class="absolute" style="background:$tkn_AAD_color$;"><a href="ssphp_foundational_systems_service?form.tkn__service=aad" target="_blank">$tkn_AAD_score_perc$</a></div>
        <div class="undervalue" style="background:$tkn_AAD_color$;"><a href="ssphp_foundational_systems_service?form.tkn__service=aad" target="_blank">AAD Entra</a></div>
      </html>
    </panel>

    <panel id="RightPanel_aad">
      <chart>
        <search>
          <query>
`ssphp_summary_index_DEV` earliest=-30d latest=now ssphp.use_case.id="aad*" ```ssphp.error.no_records="false"```
      ssphp.use_case.id!="*_000"
      ```ssphp.score.ciso_priority=1```

| eval date=strftime('SSPHP_RUN',"%Y-%m-%d")
| fields _time, SSPHP_RUN, date, ssphp.source.foundational_system, ssphp.use_case.id, ssphp.use_case.title, ssphp.score.score, ssphp.score.color, ssphp.score.ciso_priority, ssphp.benchmark.origin, ssphp.benchmark.control.title, ssphp.error.no_records
| sort 0 ssphp.use_case.id, - SSPHP_RUN
| dedup ssphp.use_case.id, date
| stats count as denominator, values(ssphp.use_case.id) as ssphp.use_case.id, sum(eval(if('ssphp.score.score'="100",1,0))) as numerator by date
| eval day_score=floor('numerator'*100/'denominator')
| table date, denominator, numerator
| rename denominator as "Not Compliant", numerator as Compliant
          </query>
          <earliest>0</earliest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.text">AAD Entra</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.abbreviation">none</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.abbreviation">none</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.lineWidth">2</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
        <option name="charting.seriesColors">[$tkn_colour_red$, $tkn_colour_green$]</option>
        <option name="height">190</option>
      </chart>
    </panel>
  </row>





<!-- ######### AZURE ROW ######### -->   
  <row depends="$tkn_ready$">

    <panel depends="$never_show$">
      <html>
        <style>
          #LeftPanel_abs_azure{
            width:70% !important;
          }
          #LeftPanel_perc_azure{
            width:70% !important;
          }
          #RightPanel_azure{
            width:30% !important;
          }
        </style>
      </html>
    </panel>

    <panel id="LeftPanel_abs_azure" depends="$tkn_show_abs$">
      <html>
        <div class="absolute" style="background:$tkn_AZURE_color$;"><a href="ssphp_foundational_systems_service?form.tkn__service=azure" target="_blank">$tkn_AZURE_score_abs$</a></div>
        <div class="undervalue" style="background:$tkn_AZURE_color$;"><a href="ssphp_foundational_systems_service?form.tkn__service=azure" target="_blank">AZURE</a></div>
      </html>
    </panel>

    <panel id="LeftPanel_perc_azure" depends="$tkn_show_perc$">
      <html>
        <div class="absolute" style="background:$tkn_AZURE_color$;"><a href="ssphp_foundational_systems_service?form.tkn__service=azure" target="_blank">$tkn_AZURE_score_perc$</a></div>
        <div class="undervalue" style="background:$tkn_AZURE_color$;"><a href="ssphp_foundational_systems_service?form.tkn__service=azure" target="_blank">AZURE</a></div>
      </html>
    </panel>

    <panel id="RightPanel_azure">
      <chart>
        <search>
          <query>
`ssphp_summary_index_DEV` earliest=-30d latest=now ssphp.use_case.id="azure*" ```ssphp.error.no_records="false"```
      ssphp.use_case.id!="*_000"
      ```ssphp.score.ciso_priority=1```

| eval date=strftime('SSPHP_RUN',"%Y-%m-%d")
| fields _time, SSPHP_RUN, date, ssphp.source.foundational_system, ssphp.use_case.id, ssphp.use_case.title, ssphp.score.score, ssphp.score.color, ssphp.score.ciso_priority, ssphp.benchmark.origin, ssphp.benchmark.control.title, ssphp.error.no_records
| sort 0 ssphp.use_case.id, - SSPHP_RUN
| dedup ssphp.use_case.id, date
| stats count as denominator, values(ssphp.use_case.id) as ssphp.use_case.id, sum(eval(if('ssphp.score.score'="100",1,0))) as numerator by date
| eval day_score=floor('numerator'*100/'denominator')
| table date, denominator, numerator
| rename denominator as "Not Compliant", numerator as Compliant
          </query>
          <earliest>0</earliest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.text">AZURE</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.abbreviation">none</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.abbreviation">none</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.lineWidth">2</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
        <option name="charting.seriesColors">[$tkn_colour_red$, $tkn_colour_green$]</option>
        <option name="height">190</option>
      </chart>
    </panel>
  </row>





<!-- ######### AWS DNS ROW ######### -->   
  <row depends="$tkn_ready$">

    <panel depends="$never_show$">
      <html>
        <style>
          #LeftPanel_abs_dns{
            width:70% !important;
          }
          #LeftPanel_perc_dns{
            width:70% !important;
          }
          #RightPanel_dns{
            width:30% !important;
          }
        </style>
      </html>
    </panel>

    <panel id="LeftPanel_abs_dns" depends="$tkn_show_abs$">
      <html>
        <div class="absolute" style="background:$tkn_DNS_color$;"><a href="ssphp_foundational_systems_service?form.tkn__service=dns" target="_blank">$tkn_DNS_score_abs$</a></div>
        <div class="undervalue" style="background:$tkn_DNS_color$;"><a href="ssphp_foundational_systems_service?form.tkn__service=dns" target="_blank">DNS [AWS]</a></div>
      </html>
    </panel>

    <panel id="LeftPanel_perc_dns" depends="$tkn_show_perc$">
      <html>
        <div class="absolute" style="background:$tkn_DNS_color$;"><a href="ssphp_foundational_systems_service?form.tkn__service=dns" target="_blank">$tkn_DNS_score_perc$</a></div>
        <div class="undervalue" style="background:$tkn_DNS_color$;"><a href="ssphp_foundational_systems_service?form.tkn__service=dns" target="_blank">DNS [AWS]</a></div>
      </html>
    </panel>

    <panel id="RightPanel_dns">
      <chart>
        <search>
          <query>
`ssphp_summary_index_DEV` earliest=-30d latest=now ssphp.use_case.id="dns*" ```ssphp.error.no_records="false"```
      ssphp.use_case.id!="*_000"
      ```ssphp.score.ciso_priority=1```

| eval date=strftime('SSPHP_RUN',"%Y-%m-%d")
| fields _time, SSPHP_RUN, date, ssphp.source.foundational_system, ssphp.use_case.id, ssphp.use_case.title, ssphp.score.score, ssphp.score.color, ssphp.score.ciso_priority, ssphp.benchmark.origin, ssphp.benchmark.control.title, ssphp.error.no_records
| sort 0 ssphp.use_case.id, - SSPHP_RUN
| dedup ssphp.use_case.id, date
| stats count as denominator, values(ssphp.use_case.id) as ssphp.use_case.id, sum(eval(if('ssphp.score.score'="100",1,0))) as numerator by date
| eval day_score=floor('numerator'*100/'denominator')
| table date, denominator, numerator
| rename denominator as "Not Compliant", numerator as Compliant
          </query>
          <earliest>0</earliest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.text">DNS [AWS]</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.abbreviation">none</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.abbreviation">none</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.lineWidth">2</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
        <option name="charting.seriesColors">[$tkn_colour_red$, $tkn_colour_green$]</option>
        <option name="height">190</option>
      </chart>
    </panel>
  </row>



<!-- ######### M365 ROW ######### -->   
  <row depends="$tkn_ready$">

    <panel depends="$never_show$">
      <html>
        <style>
          #LeftPanel_abs_m365{
            width:70% !important;
          }
          #LeftPanel_perc_m365{
            width:70% !important;
          }
          #RightPanel_m365{
            width:30% !important;
          }
        </style>
      </html>
    </panel>

    <panel id="LeftPanel_abs_m365" depends="$tkn_show_abs$">
      <html>
        <div class="absolute" style="background:$tkn_M365_color$;"><a href="ssphp_foundational_systems_service?form.tkn__service=m365" target="_blank">$tkn_M365_score_abs$</a></div>
        <div class="undervalue" style="background:$tkn_M365_color$;"><a href="ssphp_foundational_systems_service?form.tkn__service=m365" target="_blank">M365</a></div>
      </html>
    </panel>

    <panel id="LeftPanel_perc_m365" depends="$tkn_show_perc$">
      <html>
        <div class="absolute" style="background:$tkn_M365_color$;"><a href="ssphp_foundational_systems_service?form.tkn__service=m365" target="_blank">$tkn_M365_score_perc$</a></div>
        <div class="undervalue" style="background:$tkn_M365_color$;"><a href="ssphp_foundational_systems_service?form.tkn__service=m365" target="_blank">M365</a></div>
      </html>
    </panel>

    <panel id="RightPanel_m365">
      <chart>
        <search>
          <query>
`ssphp_summary_index_DEV` earliest=-30d latest=now ssphp.use_case.id="m365*" ```ssphp.error.no_records="false"```
      ssphp.use_case.id!="*_000"
      ```ssphp.score.ciso_priority=1```

| eval date=strftime('SSPHP_RUN',"%Y-%m-%d")
| fields _time, SSPHP_RUN, date, ssphp.source.foundational_system, ssphp.use_case.id, ssphp.use_case.title, ssphp.score.score, ssphp.score.color, ssphp.score.ciso_priority, ssphp.benchmark.origin, ssphp.benchmark.control.title, ssphp.error.no_records
| sort 0 ssphp.use_case.id, - SSPHP_RUN
| dedup ssphp.use_case.id, date
| stats count as denominator, values(ssphp.use_case.id) as ssphp.use_case.id, sum(eval(if('ssphp.score.score'="100",1,0))) as numerator by date
| eval day_score=floor('numerator'*100/'denominator')
| table date, denominator, numerator
| rename denominator as "Not Compliant", numerator as Compliant
          </query>
          <earliest>0</earliest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.text">M365</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.abbreviation">none</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.abbreviation">none</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.lineWidth">2</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
        <option name="charting.seriesColors">[$tkn_colour_red$, $tkn_colour_green$]</option>
        <option name="height">190</option>
      </chart>
    </panel>
  </row>



<!-- ######### GITHUB ROW ######### -->   
  <row depends="$tkn_ready$">

    <panel depends="$never_show$">
      <html>
        <style>
          #LeftPanel_abs_github{
            width:70% !important;
          }
          #LeftPanel_perc_github{
            width:70% !important;
          }
          #RightPanel_github{
            width:30% !important;
          }
        </style>
      </html>
    </panel>

    <panel id="LeftPanel_abs_github" depends="$tkn_show_abs$">
      <html>
        <div class="absolute" style="background:$tkn_GITHUB_color$;"><a href="ssphp_foundational_systems_service?form.tkn__service=github" target="_blank">$tkn_GITHUB_score_abs$</a></div>
        <div class="undervalue" style="background:$tkn_GITHUB_color$;"><a href="ssphp_foundational_systems_service?form.tkn__service=github" target="_blank">GITHUB</a></div>
      </html>
    </panel>

    <panel id="LeftPanel_perc_github" depends="$tkn_show_perc$">
      <html>
        <div class="absolute" style="background:$tkn_GITHUB_color$;"><a href="ssphp_foundational_systems_service?form.tkn__service=github" target="_blank">$tkn_GITHUB_score_perc$</a></div>
        <div class="undervalue" style="background:$tkn_GITHUB_color$;"><a href="ssphp_foundational_systems_service?form.tkn__service=github" target="_blank">GITHUB</a></div>
      </html>
    </panel>

    <panel id="RightPanel_github">
      <chart>
        <search>
          <query>
`ssphp_summary_index_DEV` earliest=-30d latest=now ssphp.use_case.id="github*" ```ssphp.error.no_records="false"```
      ssphp.use_case.id!="*_000"
      ```ssphp.score.ciso_priority=1```

| eval date=strftime('SSPHP_RUN',"%Y-%m-%d")
| fields _time, SSPHP_RUN, date, ssphp.source.foundational_system, ssphp.use_case.id, ssphp.use_case.title, ssphp.score.score, ssphp.score.color, ssphp.score.ciso_priority, ssphp.benchmark.origin, ssphp.benchmark.control.title, ssphp.error.no_records
| sort 0 ssphp.use_case.id, - SSPHP_RUN
| dedup ssphp.use_case.id, date
| stats count as denominator, values(ssphp.use_case.id) as ssphp.use_case.id, sum(eval(if('ssphp.score.score'="100",1,0))) as numerator by date
| eval day_score=floor('numerator'*100/'denominator')
| table date, denominator, numerator
| rename denominator as "Not Compliant", numerator as Compliant
          </query>
          <earliest>0</earliest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.text">GITHUB</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.abbreviation">none</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.abbreviation">none</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.lineWidth">2</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
        <option name="charting.seriesColors">[$tkn_colour_red$, $tkn_colour_green$]</option>
        <option name="height">190</option>
      </chart>
    </panel>
  </row>





<!-- ################### DATA ROW - Foundational Services ################### -->   

  <row depends="$never_show$">
    <panel>
      <table>
        <search>
          <query>
| loadjob savedsearch="nobody:$tkn_current_app$:ssphp_create_dashboard_dataset_posture{{environment}}"
| search line_type="summary" AND ssphp.source.foundational_system="*"
| eval compliant_perc='compliant_perc'."%"
| table ssphp.source.foundational_system, compliant_perc, compliant_abs, compliant_color
| foreach compliant_* [| eval {ssphp.source.foundational_system}_&lt;&lt;FIELD&gt;&gt;='&lt;&lt;FIELD&gt;&gt;']
| fields - ssphp.source.foundational_system, compliant_perc, compliant_abs, compliant_color
| stats values(*) as *
          </query>
          <done>
            <set token="tkn_AAD_color">$result.AAD_compliant_color$</set>
            <set token="tkn_AAD_score_abs">$result.AAD_compliant_abs$</set>
            <set token="tkn_AAD_score_perc">$result.AAD_compliant_perc$</set>
            
            <set token="tkn_AZURE_color">$result.AZURE_compliant_color$</set>
            <set token="tkn_AZURE_score_abs">$result.AZURE_compliant_abs$</set>
            <set token="tkn_AZURE_score_perc">$result.AZURE_compliant_perc$</set>
            
            <set token="tkn_DNS_color">$result.DNS_compliant_color$</set>
            <set token="tkn_DNS_score_abs">$result.DNS_compliant_abs$</set>
            <set token="tkn_DNS_score_perc">$result.DNS_compliant_perc$</set>
            
            <set token="tkn_M365_color">$result.M365_compliant_color$</set>
            <set token="tkn_M365_score_abs">$result.M365_compliant_abs$</set>
            <set token="tkn_M365_score_perc">$result.M365_compliant_perc$</set>
            
            <set token="tkn_GITHUB_color">$result.GITHUB_compliant_color$</set>
            <set token="tkn_GITHUB_score_abs">$result.GITHUB_compliant_abs$</set>
            <set token="tkn_GITHUB_score_perc">$result.GITHUB_compliant_perc$</set>

            <set token="tkn_ready">true</set>
          </done>
        </search>
      </table>
    </panel>
  </row>

<row depends="$tkn_show_footer$">
    <panel depends="$never_show$">
        <table>
            <search>
                <query>
| rest /services/authentication/current-context splunk_server=local 
| table username, roles
| eval roles=case(username="ian.pearl@education.gov.uk",mvappend('roles',"dfe_ssphp_service_user_s194"),
                    username="alex.kinnane@education.gov.uk",mvappend('roles',"dfe_ssphp_service_user_s194"),
                    username="sam.pritchard@education.gov.uk",mvappend('roles',"dfe_ssphp_service_user_s194"),
                    1==1,'roles')
| eval roles=mvfilter(match('roles',"dfe_ssphp_service_user_s\d{3}"))
| where isnotnull('roles')
| rex field=roles "dfe_ssphp_service_user_(?&lt;service&gt;s\d{3})$"
| eval app=$env:app|s$
| table username, service, app
                </query>
                <done>
                    <set token="tkn__current_user_name">$result.username$</set>
                    <set token="tkn__current_user_service">$result.service$</set>
                    <set token="tkn__current_application">$result.app$</set>
                </done>
            </search>
        </table>
    </panel>

    <panel>
        <html>Current User : $tkn__current_user_name$&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Current App : $tkn__current_application$&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;User Service : $tkn__current_user_service$&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Version : b8426922ff920f75f2db6b3f72dcbd42795a75f6</html>
    </panel>
</row>


    <row depends="$show_debug$">
        <panel>
            <title>DEBUG DATA : Data Sources</title>
            <table>
                <search>
                    <query>
    | tstats max(_time) as last_run where `ssphp_metrics_data_index{{environment}}` by index, sourcetype
    | eval last_run=strftime('last_run',"%Y-%m-%d %H:%M:%S")
    | table index, sourcetype, last_run
    | sort 0 - last_run
                    </query>
                </search>
                <option name="count">50</option>
            </table>
        </panel>

        <panel>
            <title>DEBUG DATA : Use Cases</title>
            <table>
                <search>
                    <query>
`ssphp_summary_index{{environment}}` earliest=-30d@d latest=now ssphp.use_case.savedsearch="*{{environment}}"
| stats values(ssphp.use_case.savedsearch) as ssphp.use_case.savedsearch, max(SSPHP_RUN) as SSPHP_RUN by ssphp.use_case.id
| eval last_run=strftime('SSPHP_RUN',"%Y-%m-%d %H:%M:%S")
| table ssphp.use_case.id, ssphp.use_case.savedsearch, last_run, SSPHP_RUN
| sort 0 - last_run
                    </query>
                </search>
                <option name="count">50</option>
            </table>
        </panel>
    </row>

</dashboard>