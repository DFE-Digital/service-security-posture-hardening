[ssphp_use_case_m365_001_cis_1-1-14{{environment}}]
cron_schedule = 10 4 * * *
dispatch.earliest_time = 0
dispatch.latest_time = now
enableSched = 1
search = """

`ssphp_metrics_data_index{{environment}}` sourcetype="SSPHP.AAD.conditional_access_policy" earliest=-7d
         [| search `ssphp_metrics_data_index{{environment}}` sourcetype="SSPHP.AAD.conditional_access_policy" earliest=-7d
          | stats max(SSPHP_RUN) as SSPHP_RUN
          | return SSPHP_RUN]
     
| spath id
| spath displayName
| spath hasUntrustedConditions{}
| spath grantControls.builtInControls{}
| spath grantControls.authenticationStrength.requirementsSatisfied
| spath state, 
| spath conditions.applications.includeApplications{}
| spath conditions.clientAppTypes{}
| spath grantControls.operator
| spath conditions.userRiskLevels{}

| fields id, displayName, grantControls.builtInControls{}, grantControls.authenticationStrength.requirementsSatisfied, state, conditions.applications.includeApplications{}, conditions.clientAppTypes{}, grantControls.operator, conditions.userRiskLevels{}, hasUntrustedConditions{}
| rename * as cap_*, *{} as *
| table cap_*

| fillnull value="-" cap_conditions.applications.includeApplications, cap_conditions.clientAppTypes, cap_state, cap_grantControls.builtInControls, cap_grantControls.authenticationStrength.requirementsSatisfied, cap_hasUntrustedConditions, cap_grantControls.operator
| makemv ssphp.score.non_compliant_fields
| eval ssphp.score.non_compliant_fields=if(upper('cap_conditions.applications.includeApplications')="ALL",
                                           'ssphp.score.non_compliant_fields',
                                           mvappend('ssphp.score.non_compliant_fields', "cap_conditions.applications.includeApplications")),
       ssphp.score.non_compliant_fields=if(upper('cap_conditions.userRiskLevels')="HIGH",
                                           'ssphp.score.non_compliant_fields',
                                           mvappend('ssphp.score.non_compliant_fields', "cap_conditions.userRiskLevels")),
       ssphp.score.non_compliant_fields=if(upper('cap_conditions.clientAppTypes')="ALL",
                                           'ssphp.score.non_compliant_fields',
                                           mvappend('ssphp.score.non_compliant_fields', "cap_conditions.clientAppTypes")),
       ssphp.score.non_compliant_fields=if(upper('cap_state')="ENABLED",
                                           'ssphp.score.non_compliant_fields',
                                           mvappend('ssphp.score.non_compliant_fields', "cap_state")),
       ssphp.score.non_compliant_fields=if(upper('cap_grantControls.builtInControls')="MFA" OR upper('cap_grantControls.authenticationStrength.requirementsSatisfied')="MFA",
                                           'ssphp.score.non_compliant_fields',
                                           mvappend('ssphp.score.non_compliant_fields', "cap_grantControls.builtInControls", "cap_grantControls.authenticationStrength.requirementsSatisfied")),
       ssphp.score.non_compliant_fields=if(upper('cap_grantControls.builtInControls')="PASSWORDCHANGE" OR upper('cap_grantControls.authenticationStrength.requirementsSatisfied')="PASSWORDCHANGE",
                                           'ssphp.score.non_compliant_fields',
                                           mvappend('ssphp.score.non_compliant_fields', "cap_grantControls.builtInControls", "cap_grantControls.authenticationStrength.requirementsSatisfied")),
       ssphp.score.non_compliant_fields=if(upper('cap_grantControls.operator')="AND",
                                           'ssphp.score.non_compliant_fields',
                                           mvappend('ssphp.score.non_compliant_fields', "cap_grantControls.operator")),
       ssphp.score.non_compliant_fields=if('cap_hasUntrustedConditions'="-",
                                           'ssphp.score.non_compliant_fields',
                                           mvappend('ssphp.score.non_compliant_fields', "cap_hasUntrustedConditions"))

| eval compliant_policy=if(isnull('ssphp.score.non_compliant_fields'),"1","0"),
       no_breaches=mvcount('ssphp.score.non_compliant_fields')

```| sort 0 - userPrincipalName, compliant_policy, no_breaches```

| fields cap_id, cap_displayName, cap_conditions.userRiskLevels, cap_conditions.applications.includeApplications, cap_conditions.clientAppTypes, cap_state, cap_grantControls.builtInControls, cap_grantControls.authenticationStrength.requirementsSatisfied, cap_grantControls.operator, cap_hasUntrustedConditions
         compliant_policy, ssphp.score.non_compliant_fields
         


``` ##################### end dashboard query ##################### ```

| eval ssphp.score.numerator=coalesce(mvcount('ssphp.score.non_compliant_fields'),0),
       ssphp.score.denominator=8,
       ssphp.score.score=if('ssphp.score.numerator'=0,100,0)


| stats max(ssphp.score.score) as ssphp.score.score, sum(eval(if('ssphp.score.numerator'=0,1,0))) as ssphp.score.numerator, count as ssphp.score.denominator

`ssphp_use_case_write_null_output_override{{environment}}(0)`


``` ##################### add metadata ##################### ```
| eval SSPHP_RUN=round(now()),
       ssphp.use_case.id="m365_001_cis_1-1-14",

       ssphp.use_case.version.number="4.0.1",
       ssphp.use_case.version.last_changed_date="2026-01-28",
       ssphp.use_case.version.last_changed_by="Ian Pearl & Alex Kinnane",
       
       ssphp.microsoft.description=coalesce('description',"-"),
       ssphp.microsoft.implementation_status=coalesce('implementationStatus',"-")

`ssphp_use_case_add_cis_metadata_m365{{environment}}`

| eval ssphp.risk.expectancy="5",
       ssphp.risk.impact="5",
       ssphp.score.ciso_priority="1",
       ssphp.score.threshold.green="99",
       ssphp.score.threshold.orange="-",
       ssphp.score.threshold.red="-"

| eval ssphp.source.service="M365",
       ssphp.source.service_name="M365",
       ssphp.use_case.savedsearch="ssphp_use_case_m365_001_cis_1-1-14{{environment}}"


| eval ssphp.score.scoring_narrative="In order to be compliant there must be at least 1 Conditonal Access Policy which meets the following conditions :
Enabled = true
ap_conditions.userRiskLevels = HIGH
cap_conditions.applications.includeApplications = ALL
cap_conditions.clientAppTypes = ALL
cap_grantControls.builtInControls = MFA OR cap_grantControls.authenticationStrength.requirementsSatisfied = MFA
cap_grantControls.builtInControls = PASSWORDCHANGE OR cap_grantControls.authenticationStrength.requirementsSatisfied = PASSWORDCHANGE
cap_grantControls.operator=AND"

| eval ssphp.score.color=case('ssphp.score.score'>'ssphp.score.threshold.green',"green",1==1,"red")


`ssphp_use_case_write{{environment}}`

"""
